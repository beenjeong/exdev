<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="conResult">

	<cache />

	<!--
	인사정보 관리 
	 -->	
	<select id="getContractInfoList" resultType="java.util.HashMap" flushCache="true"  useCache="false">
		/*	conResult.getContractInfoList
			실적 입력 내역 리스트 조회 
		*/
		WITH RESULT_LIST AS
		(
				SELECT 
				 R.RESULT_ID
				,TO_CHAR( R.RESULT_DATE,   'YYYY-MM-DD') AS RESULT_DATE /* 실적일 */
				,TO_CHAR( R.RESULT_DATE,   'YYYY') AS RESULT_YEAR /* 실적년 */
				,TO_CHAR( R.RESULT_DATE,   'MM') AS RESULT_MONTH /* 실적월 */
				,NULL 							 AS TEAM  
				,C.HOW_GET
				,GET_CODE_NM('HOW_GET', C.HOW_GET)		AS HOW_GET_NM /* 유입경로 */
				,C.CONTRACT_TYPE
				,GET_CODE_NM('CONTRACT_TYPE', C.CONTRACT_TYPE)		AS CONTRACT_TYPE_NM /* 구분 */ 
				,C.USER_ID AS CONTRACT_USER_ID /*담당자*/
				,GET_USER_NM(C.USER_ID) AS CONTRACT_USER_NM /* 담당자*/
				,B.COMPANY_REGNUM 						/* 사업자등록번호*/
				,B.BUYER_NM								/*거래처 */
				,CT.CONSULTING_NM						/*컨설팅 명*/
				,C.TOTAL_COST							/*총계약 금액*/
				,R.INCOME/*입금액*/
				,R.REMAINING_SUM/*잔금*/
				,R.ORG_SELLING_PRICE/*순매출*/
				,RL.SHARE_RATE  /*지급율*/
				,R.TOTAL_PAYMENT/*총수수료*/
				,P.PAYMENT /*담당자수수료*/
				,DECODE(  RL.GUBUN , 'CO_WORK1' , GET_USER_NM(RL.USER_ID),'') AS COWORK1_USER_NM/*코웍1*/
				,DECODE(  RL.GUBUN , 'CO_WORK1' , RL.SHARE_RATE,0) ||'%' AS COWORK1_SHARE_RATE/*코웍1*/
				,DECODE(  RL.GUBUN , 'CO_WORK1' , RL.SHARE_RATE,0) *  R.ORG_SELLING_PRICE AS COWORK1_PAYMENT/*코웍1*/
		
				,DECODE(  RL.GUBUN , 'CO_WORK2' , GET_USER_NM(RL.USER_ID),'') AS COWORK2_USER_NM/*코웍2*/
				,DECODE(  RL.GUBUN , 'CO_WORK2' , RL.SHARE_RATE,0) ||'%' AS COWORK2_SHARE_RATE/*코웍2*/
				,DECODE(  RL.GUBUN , 'CO_WORK2' , RL.SHARE_RATE,0) *  R.ORG_SELLING_PRICE AS COWORK2_PAYMENT/*코웍2*/
				
				,( DECODE(RL.RELATION_TYPE , 'TEAM_CAPTAIN' , RL.SHARE_RATE , 0) * R.ORG_SELLING_PRICE ) AS TEAM_CAPTAIN_PAYMENT/*팀장 수당 */ 
				,( DECODE(RL.RELATION_TYPE , 'CONTRACTOR' , RL.SHARE_RATE , 0) * R.ORG_SELLING_PRICE ) AS CONTRACTOR_PAYMENT/*지점장수당  */
				,C."CONTRACT_ID"
				,C.USER_ID
				,C.SP_CSTM_ID
				,TO_CHAR( C.CONTACT_DATE , 'YYYY-MM-DD') AS CONTACT_DATE
				,TO_CHAR( C.CONTRACT_DATE, 'YYYY-MM-DD') AS CONTRACT_DATE
				,C.CONSULTING_COST
				,TO_CHAR( C.EXPIRE_DATE,   'YYYY-MM-DD') AS EXPIRE_DATE
				,C.CONSULTING_ID
				,C.LAST_SOLUTION
				,C.TAX_MNG
				,C.LABOR_MNG
				,C.BUYER_ID
				,C.PROCESS_STATE
				,GET_CODE_NM('PROCESS_STATE', C.PROCESS_STATE)		AS PROCESS_STATE_NM
				,b.tel AS BUYER_TEL
				,b.addr AS BUYER_ADDR 
		
				,COST.COST_ID
				,COST.COST_NM
				,COST.COST_DESC
				,COST.COST_PRICE
				,P.USER_ID AS PAYMENT_USER_ID
				,RL.RELATION_TYPE
				,GET_CODE_NM('RELATION_TYPE', RL.RELATION_TYPE)		AS RELATION_TYPE_NM
				,GET_CODE_NM('SHARE_TYPE', RL.SHARE_TYPE)		AS SHARE_TYPE_NM
				FROM TBL_EXP_RESULT R 
				, TBL_EXP_CONTRACT C
				, TBL_EXP_BUYER B
				, TBL_EXP_CONSULTING CT
				, TBL_EXP_COST COST
				, TBL_EXP_PAYMENT P
				, (
					SELECT 
					    CASE 
					        WHEN RELATION_TYPE = 'CO_WORK' 
					        THEN 'CO_WORK' || ROW_NUMBER() OVER(PARTITION BY RELATION_TYPE ORDER BY CONTRACT_ID)
					        ELSE RELATION_TYPE
					    END AS GUBUN,
					    CONTRACT_ID,
					    RELATION_TYPE,
					    USER_ID,
					    SHARE_RATE,
					    SHARE_TYPE
					FROM  TBL_EXP_CONTRACT_RELATION
				) RL
				WHERE 1=1
				AND R.CONTRACT_ID	= C.CONTRACT_ID 
				AND C.BUYER_ID		= B.BUYER_ID
				AND C.CONSULTING_ID	= CT.CONSULTING_ID
				
				AND C.CONTRACT_ID = COST.CONTRACT_ID
				AND C.CONTRACT_ID = P.CONTRACT_ID
				AND C.CONTRACT_ID = RL.CONTRACT_ID
				AND C.SP_CSTM_ID = B.SP_CSTM_ID
		
				ORDER BY RESULT_DATE
		)		
			
		SELECT  DISTINCT
				 RESULT_ID
				,RESULT_YEAR 	/* 실적년 */
				,RESULT_MONTH 	/* 실적월 */
				,TEAM  
				,HOW_GET
				,HOW_GET_NM 	/* 유입경로*/
				,CONTRACT_TYPE
				,CONTRACT_TYPE_NM /* 구분 */
				,CONTRACT_USER_ID /*담당자*/
				,CONTRACT_USER_NM /* 담당자*/
				,COMPANY_REGNUM 	/* 사업자등록번호*/
				,BUYER_NM			/*거래처 */
				,CONSULTING_NM		/*컨설팅 명*/
				,CONSULTING_ID
				
				,TOTAL_COST			/*총계약 금액*/
				,INCOME				/*입금액*/
				,REMAINING_SUM		/*잔금*/
				,ORG_SELLING_PRICE	/*순매출*/
				,TOTAL_PAYMENT		/*총수수료*/
				
				,MAX(PAYMENT)			AS PAYMENT 
				,MAX(COWORK1_USER_NM)	AS COWORK1_USER_NM/*코웍1*/
				,MAX(COWORK1_SHARE_RATE) AS COWORK1_SHARE_RATE	
				,MAX(COWORK1_PAYMENT) AS COWORK1_PAYMENT	
				,MAX(COWORK2_USER_NM) AS COWORK2_USER_NM	/*코웍2*/
				,MAX(COWORK2_SHARE_RATE) AS COWORK2_SHARE_RATE	
				,MAX(COWORK2_PAYMENT) AS COWORK2_PAYMENT	
				,MAX(TEAM_CAPTAIN_PAYMENT) AS TEAM_CAPTAIN_PAYMENT/*팀장 수당*/ 
				,MAX(CONTRACTOR_PAYMENT) AS CONTRACTOR_PAYMENT		/*지점장수당*/
		
				,MAX(SHARE_RATE) SHARE_RATE  		/*지급율*/
		
		FROM RESULT_LIST
		
		GROUP BY 
				 RESULT_ID
				,RESULT_YEAR 	/* 실적년 */
				,RESULT_MONTH 	/* 실적월 */
				,TEAM  
				,HOW_GET
				,HOW_GET_NM 	/* 유입경로*/
				,CONTRACT_TYPE
				,CONTRACT_TYPE_NM /* 구분*/ 
				,CONTRACT_USER_ID /*담당자*/
				,CONTRACT_USER_NM /* 담당자*/
				,COMPANY_REGNUM 	/* 사업자등록번호*/
				,BUYER_NM			/*거래처 */
				,CONSULTING_NM		/*컨설팅 명*/
				,CONSULTING_ID
				,TOTAL_COST			/*총계약 금액*/
				
				,INCOME				/*입금액*/
				,REMAINING_SUM		/*잔금*/
				,ORG_SELLING_PRICE	/*순매출*/
				,TOTAL_PAYMENT		/*총수수료*/
		ORDER BY RESULT_ID				
	</select>

	<!--
	계약 관리 
	 -->	
	<select id="getContractList" resultType="java.util.HashMap" flushCache="true"  useCache="false">
		/*	conResult.getContractList
			계약 리스트 조회 
		*/
		SELECT C.CONTRACT_ID
		,C.BUYER_ID 
		,B.BUYER_NM
		,C.PROCESS_STATE 
		,TO_CHAR( C.CONTACT_DATE , 'YYYY-MM-DD') AS CONTACT_DATE 
		,C.USER_ID AS CONTRACT_USER_ID
		,GET_USER_NM(C.USER_ID) AS CONTRACT_USER_NM /* 담당자*/
		,C.CONTRACT_TYPE_CODE_ID
		,GET_CODE_NM('CONTRACT_TYPE_CODE', C.CONTRACT_TYPE_CODE_ID)		AS CONTRACT_TYPE_CODE_NM
		,C.TOTAL_COST /* 계약금액 */
		,TO_CHAR( C.CONTRACT_DATE , 'YYYY-MM-DD' ) AS CONTRACT_DATE 
		,C.CONSULTING_COST 
		,TO_CHAR( C.EXPIRE_DATE , 'YYYY-MM-DD' ) AS EXPIRE_DATE 
		,C.TOTAL_COST /* 총계약금액 */
		,'컨설팅명' CONSULTING_NM /* 컨설팅명 */
		FROM TBL_EXP_CONTRACT C
		,TBL_EXP_BUYER B
		WHERE C.BUYER_ID = B.BUYER_ID(+)
	</select>	

	<select id="getBuyerList" resultType="java.util.HashMap" flushCache="true"  useCache="false">
		/*	conResult.getBuyerList
			고객 리스트 조회 
		*/
		SELECT BUYER_ID
		, BUYER_NM
		, TEL
		, ADDR
		, COMPANY_REGNUM
		FROM TBL_EXP_BUYER
		WHERE  1=1
		AND ( UPPER(BUYER_ID) like '%' || UPPER( #{SEARCH_ID} ) || '%'
		OR    UPPER(BUYER_NM) like '%' || UPPER( #{SEARCH_ID} ) || '%'
		)
		AND USE_YN = 'Y'
		AND DEL_YN = 'N'
	</select>		

	<select id="getUserList" resultType="java.util.HashMap" flushCache="true"  useCache="false">
		/*	conResult.getUserList
			계약 담당자 리스트 조회 
		*/
		SELECT SP_CSTM_ID
		, USER_ID
		, USER_NM
		, USER_DESC
		, E_MAIL
		, PHONE_NUM
		, BRANCH_ID
		, "ROLE"
		, GRADE
		, STATE
		, REG_DATE
		, JUMIN
		, POST_NUM
		, ADDR1
		, ADDR2
		, UPDATE_USER
		, UPDATE_DATE
		, SURETY_INSURANCE
		, GENDER
		, GRADE_CODE_ID
		, SALES_TYPE_CODE_ID
		, GET_CODE_NM('SALES_TYPE_CODE_ID', SALES_TYPE_CODE_ID)		AS SALES_TYPE_CODE_NM
		FROM TBL_EXP_USER
		WHERE 1=1
		AND ( UPPER(USER_ID) like '%' || UPPER( #{SEARCH_ID} ) || '%'
		OR    UPPER(USER_NM) like '%' || UPPER( #{SEARCH_ID} ) || '%'
		)
		AND USE_YN = 'Y'
		AND DEL_YN = 'N'
	</select>	
</mapper>
