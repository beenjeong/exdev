<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approval">

	<cache />
	
      <!--  결재상태 조회 이응규 -->
    <select id="getApprovalState" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApprovalState */
        SELECT  CASE WHEN A.TOTAL_CNT = B.COMP_CNT THEN 'COMPLETE'
                     WHEN B.COMP_CNT = 0 THEN 'REQUEST'
                     ELSE 'PROCESS'
               END AS APPR_STATE
        FROM   (
                SELECT COUNT(1) AS TOTAL_CNT FROM   TBL_EXP_APPROVAL_USER WHERE  APPROVAL_ID = #{approvalId} 
               ) A,
               (
                SELECT COUNT(1) AS COMP_CNT  FROM   TBL_EXP_APPROVAL_USER WHERE  APPROVAL_ID = #{approvalId} AND  STATE = 'COMPLETE'
               ) B
        WHERE  1 = 1
    </select>
    
     <!--  결재 업데이트 이응규 -->
    <update id="updateApproval" parameterType="java.util.HashMap"  flushCache="true" >
        /*  approval.updateApproval */
        UPDATE TBL_EXP_APPROVAL
        SET    UPDATE_USER = #{sessionVo.userId}
              ,UPDATE_DATE = (TO_DATE(#{updateDate} , 'yyyy/mm/dd hh24:mi:ss') )
              <if test=" state != null and state != '' " >
                 ,STATE = #{state}
              </if>
        WHERE  1 = 1
        <if test=" approvalId != null and approvalId != '' " >
            AND    APPROVAL_ID = #{approvalId}
        </if>
    </update>

     <!--  결재자 업데이트 이응규 -->
    <update id="updateApprovalUser" parameterType="java.util.HashMap"  flushCache="true" >
        /*  approval.updateApprovalUser */
        UPDATE TBL_EXP_APPROVAL_USER
        SET    UPDATE_USER = #{updateUser}
              ,UPDATE_DATE = (TO_DATE(#{updateDate} , 'yyyy/mm/dd hh24:mi:ss') )
              <if test=" approvalType != null and approvalType != '' " >
                 ,APPROVAL_TYPE = #{approvalType}
              </if>
              <if test=" state != null and state != '' " >
                 ,STATE = #{state}
              </if>
              <if test=" approvalComment != null and approvalComment != '' " >
                 ,APPROVAL_COMMENT = #{approvalComment}
              </if>
        WHERE  1 = 1
        <if test=" approvalId != null and approvalId != '' " >
            AND    APPROVAL_ID = #{approvalId}
        </if>
        <if test=" approvalUserId != null and approvalUserId != '' " >
            AND    USER_ID = #{approvalUserId}
        </if>
    </update>
	
    <!--  미결,기결 조회 이응규 -->
    <select id="getApprovalUserState" resultType="java.util.HashMap" flushCache="true"  useCache="false">
	/* approval.getApprovalUserState */
     SELECT ROWNUM
           ,A.APPROVAL_ID   
           ,A.SP_CSTM_ID    
           ,A.USER_ID
           ,A.APPROVAL_USER_ID    
           ,A.USER_NM
           ,A.TITLE         
           ,A.CONTENTS      
           ,A.STATE         
           ,A.STATE_NM         
           ,A.APPROVAL_DATE 
           ,A.APPROVAL_DATE1
           ,A.COMPLETE_DATE 
           ,A.COMPLETE_DATE1
           ,A.UPDATE_USER   
           ,A.UPDATE_DATE  
           ,A.UPDATE_DATE1 
           ,A.CREATE_USER   
           ,A.CREATE_DATE1 
     FROM   (
            /* approval.getApprovalUserState */
            SELECT  B.APPROVAL_ID   
                   ,B.SP_CSTM_ID    
                   ,B.USER_ID 
                   ,A.USER_ID  AS APPROVAL_USER_ID    
                   ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = B.USER_ID AND SP_CSTM_ID = B.SP_CSTM_ID) AS USER_NM
                   ,B.TITLE         
                   ,B.CONTENTS    
                   ,A.STATE
                   ,GET_CODE_NM('APPROVAL_USER_PROC',A.STATE) AS STATE_NM    
                   ,B.STATE   AS APPROVAL_STATE  
                   ,B.APPROVAL_DATE 
                   ,TO_CHAR( B.APPROVAL_DATE , 'YYYY-MM-DD HH24:MI:SS' ) APPROVAL_DATE1
                   ,B.COMPLETE_DATE 
                   ,TO_CHAR( B.COMPLETE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) COMPLETE_DATE1
                   ,B.UPDATE_USER   
                   ,B.UPDATE_DATE  
                   ,TO_CHAR( B.UPDATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) UPDATE_DATE1 
                   ,B.CREATE_USER   
                   ,TO_CHAR( B.CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
            FROM   TBL_EXP_APPROVAL_USER A
                   JOIN TBL_EXP_APPROVAL B
                     ON  1 = 1
                     AND A.APPROVAL_ID = B.APPROVAL_ID
                     <if test=" startDate != null and startDate != '' and endDate != null and endDate != '' " >
	                    AND   B.APPROVAL_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')   
	                </if>
            WHERE  1 = 1
            <if test=" sessionVo != null and !sessionVo.equals('') ">
                AND A.SP_CSTM_ID = #{sessionVo.spCstmId}
            </if> 
            <if test=" approvalUserId != null and approvalUserId != '' " >
                AND A.USER_ID = 'trigger11kr'     /* 'windrider' */
            </if>
            <if test=" searchType == 'SUSPENSE' " >/* 미결조회 */
              AND    A.APPROVAL_TYPE = 'APPR' /* 결재 */
              AND    A.STATE = 'SUSPENSE'  /* 'SUSPENSE' */
            </if>
            <if test=" searchType == 'DECISION' " >/* 기결조회 */
              AND    A.APPROVAL_TYPE = 'APPR' /* 결재 */
              AND    A.STATE = 'COMPLETE'  /* 'COMPLETE' */
            </if>
            <if test=" searchType == 'NOTICE' " >/* 통보 조회 */
              AND    A.APPROVAL_TYPE = 'NOTICE' /* 결재 */
            </if>
            ORDER BY B.APPROVAL_DATE DESC
            ) A  
    </select>
    
        <!--  결재자 조회 이응규 -->
    <select id="getApprovalUser" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApprovalUser */
        SELECT B.APPROVAL_ID
              ,B.SP_CSTM_ID
              ,B.USER_ID
              ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = B.USER_ID AND SP_CSTM_ID = B.SP_CSTM_ID) AS APPROVAL_USER_NM
              ,B.STATE
              ,B.APPROVAL_COMMENT
              ,B.UPDATE_USER
              ,B.UPDATE_DATE
              ,B.CREATE_USER
              ,B.CREATE_DATE
              ,TO_CHAR( B.CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
        FROM   TBL_EXP_APPROVAL A
               JOIN TBL_EXP_APPROVAL_USER B
                 ON  1 = 1
                 AND A.APPROVAL_ID= B.APPROVAL_ID
        WHERE  1 = 1
        <if test=" sessionVo != null and !sessionVo.equals('') ">
            AND A.SP_CSTM_ID = #{sessionVo.spCstmId}
        </if>   
        <if test=" requestUser != null and requestUser != '' " >
          AND    A.USER_ID = #{requestUser}
        </if><if test=" approvalId != null and approvalId != '' " >
          AND    A.APPROVAL_ID = #{approvalId}
        </if>
        
        ORDER BY B.CREATE_DATE DESC
    </select>
    
    <!--  결재 조회 이응규 -->
    <select id="getApproval" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApproval */
		 SELECT ROWNUM
		       ,A.APPROVAL_ID   
		       ,A.SP_CSTM_ID    
		       ,A.USER_ID   
		       ,A.USER_NM
		       ,A.TITLE         
		       ,A.CONTENTS      
		       ,A.STATE       
		       ,A.STATE_NM  
		       ,A.APPROVAL_DATE 
		       ,A.APPROVAL_DATE1
		       ,A.COMPLETE_DATE 
		       ,A.COMPLETE_DATE1
		       ,A.UPDATE_USER   
		       ,A.UPDATE_DATE  
		       ,A.UPDATE_DATE1 
		       ,A.CREATE_USER   
		       ,A.CREATE_DATE1 
		 FROM   (
		        SELECT  A.APPROVAL_ID   
		               ,A.SP_CSTM_ID    
		               ,A.USER_ID   
		               ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = A.USER_ID AND SP_CSTM_ID = A.SP_CSTM_ID) AS USER_NM
		               ,A.TITLE         
		               ,A.CONTENTS      
		               ,A.STATE  
		               ,GET_CODE_NM('APPR_PROC_STATE',A.STATE) AS STATE_NM       
		               ,A.APPROVAL_DATE 
		               ,TO_CHAR( A.APPROVAL_DATE , 'YYYY-MM-DD HH24:MI:SS' ) APPROVAL_DATE1
		               ,A.COMPLETE_DATE 
		               ,TO_CHAR( A.COMPLETE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) COMPLETE_DATE1
		               ,A.UPDATE_USER   
		               ,A.UPDATE_DATE  
		               ,TO_CHAR( A.UPDATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) UPDATE_DATE1 
		               ,A.CREATE_USER   
		               ,TO_CHAR( A.CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
		        FROM  TBL_EXP_APPROVAL A
		        WHERE 1 = 1
		        <if test=" searchUserId != null and searchUserId != '' " >
		            AND   A.USER_ID    = #{searchUserId}
		        </if>
		        <if test=" approvalId != null and approvalId != '' " >
		            AND   A.APPROVAL_ID = #{approvalId}
		        </if>
		        <if test=" state != null and state != '' " >
		            AND   A.STATE = #{state}
		        </if>
                <if test=" startDate != null and startDate != '' and endDate != null and endDate != '' " >
                    AND   A.APPROVAL_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')   
                </if>
		            AND A.SP_CSTM_ID = #{sessionVo.spCstmId}
		        ORDER BY APPROVAL_DATE DESC
		        ) A    
    </select>

    <!-- 결재 입력  이응규 -->
    <insert id="insertApproval" parameterType="map" >
        /* approval.insertApproval */
        INSERT INTO TBL_EXP_APPROVAL (
		    APPROVAL_ID   
		   ,USER_ID       
		   ,TITLE         
		   ,CONTENTS 
		   ,STATE         
		   ,APPROVAL_DATE 
		   ,CREATE_USER   
		   ,CREATE_DATE 
		   ,SP_CSTM_ID    
        )
        VALUES(
		    #{APPROVAL_ID		}   
		   ,#{sessionVo.userId 	}
		   ,#{TITLE         	}
		   ,#{CONTENTS      	}
		   ,#{STATE		      	}
		   ,sysdate
           ,#{sessionVo.userId 	}
           ,sysdate
           ,#{sessionVo.spCstmId}
        )   
    </insert>
    
    <insert id="insertApprovalUser" parameterType="map" >
        /* approval.insertApprovalUser */
        INSERT INTO TBL_EXP_APPROVAL_USER (
             APPROVAL_ID     
            ,ORDER_NUM       
            ,USER_ID         
            ,APPROVAL_TYPE   
            ,APPROVAL_COMMENT
            ,CREATE_USER     
            ,CREATE_DATE     
            ,SP_CSTM_ID      
        )
        VALUES(
             #{APPROVAL_ID			}     
            ,#{ORDER_NUM        	}
            ,#{USER_ID          	}
            ,#{APPROVAL_TYPE    	}
            ,NULL
            ,#{sessionVo.userId 	}
            ,sysdate
            ,#{sessionVo.spCstmId	}
        )    
    </insert>


    
    <!-- 결재자 입력  이응규 -->
<!--     
    <insert id="insertApprovalUser" parameterType="map" >
        /* approval.insertApprovalUser */
        INSERT INTO TBL_EXP_APPROVAL_USER (
             APPROVAL_ID     
            ,ORDER_NUM       
            ,SP_CSTM_ID      
            ,USER_ID         
            ,APPROVAL_TYPE   
           
            ,APPROVAL_COMMENT
            ,CREATE_USER     
            ,CREATE_DATE     
           )
        VALUES(
            
             #{approvalId}
            ,(SELECT NVL2( MAX(ORDER_NUM), MAX(ORDER_NUM)+1 ,1 ) AS ORDER_NUM FROM TBL_EXP_APPROVAL_USER WHERE APPROVAL_ID = #{approvalId})
            ,'1234567890123456' 
            ,#{approvalUserId}
            ,#{apprType}

            ,#{approvalComment}
            ,'trigger11kr'
            ,(TO_DATE(#{createDate} , 'yyyy/mm/dd hh24:mi:ss') )
           )    
    </insert>
 -->    
    
    
    
    
    
    <!-- 결재자 입력  이응규 -->
    <insert id="insertApprovalUser_BAK" parameterType="map" >
        /* approval.insertApprovalUser */
        INSERT INTO TBL_EXP_APPROVAL_USER (
             UUID
            ,APPROVAL_UUID
            ,APPROVAL_USER_ID
            ,APPROVAL_TYPE
            ,STATE
            
            ,APPROVAL_COMMENT
            ,CREATE_USER
            ,CREATE_DATE
           )
        VALUES(
            
             #{uuid}
            ,#{approvalUuid}
            ,#{approvalUserId}
            ,#{apprType}
            ,#{state}
            
            ,#{approvalComment}
           ,#{createUser}
           ,(TO_DATE(#{createDate} , 'yyyy/mm/dd hh24:mi:ss') )
           )    
    </insert>
</mapper>
