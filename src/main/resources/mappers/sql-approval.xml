<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="approval">

	<cache />
	
      <!--  결재상태 조회 이응규 -->
    <select id="getApprovalState" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApprovalState */
        SELECT  CASE WHEN A.TOTAL_CNT = B.COMP_CNT THEN 'COMPLETE'
                     WHEN B.COMP_CNT = 0 THEN 'REQUEST'
                     ELSE 'PROCESS'
               END AS APPR_STATE
        FROM   (
                SELECT COUNT(1) AS TOTAL_CNT FROM   TBL_EXP_APPROVAL_USER WHERE  APPROVAL_UUID = #{approvalUuid} 
               ) A,
               (
                SELECT COUNT(1) AS COMP_CNT  FROM   TBL_EXP_APPROVAL_USER WHERE  APPROVAL_UUID = #{approvalUuid} AND  STATE = 'COMPLETE'
               ) B
        WHERE  1 = 1
    </select>
    
     <!--  결재 업데이트 이응규 -->
    <update id="updateApproval" parameterType="java.util.HashMap"  flushCache="true" >
        /*  approval.updateApproval */
        UPDATE TBL_EXP_APPROVAL
        SET    UPDATE_USER = #{updateUser}
              ,UPDATE_DATE = (TO_DATE(#{updateDate} , 'yyyy/mm/dd hh24:mi:ss') )
              <if test=" state != null and state != '' " >
                 ,STATE = #{state}
              </if>
        WHERE  1 = 1
        <if test=" uuid != null and uuid != '' " >
            AND    UUID = #{uuid}
        </if>
    </update>

     <!--  결재자 업데이트 이응규 -->
    <update id="updateApprovalUser" parameterType="java.util.HashMap"  flushCache="true" >
        /*  approval.updateApprovalUser */
        UPDATE TBL_EXP_APPROVAL_USER
        SET    UPDATE_USER = #{updateUser}
              ,UPDATE_DATE = (TO_DATE(#{updateDate} , 'yyyy/mm/dd hh24:mi:ss') )
              <if test=" approvalType != null and approvalType != '' " >
                 ,APPROVAL_TYPE = #{approvalType}
              </if>
              <if test=" state != null and state != '' " >
                 ,STATE = #{state}
              </if>
              <if test=" approvalComment != null and approvalComment != '' " >
                 ,APPROVAL_COMMENT = #{approvalComment}
              </if>
        WHERE  1 = 1
        <if test=" uuid != null and uuid != '' " >
            AND    UUID = #{uuid}
        </if>
        <if test=" approvalUuid != null and approvalUuid != '' " >
            AND    APPROVAL_UUID = #{approvalUuid}
        </if>
        <if test=" approvalUserId != null and approvalUserId != '' " >
            AND    APPROVAL_USER_ID = #{approvalUserId}
        </if>
    </update>
	
    <!--  미결,기결 조회 이응규 -->
    <select id="getApprovalUserState" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApprovalUserState */
        SELECT UUID
              ,REQUEST_USER
              ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = REQUEST_USER) AS REQUEST_USER_NM
              ,TITLE
              ,CONTENTS
              ,STATE
              ,APPROVAL_DATE
              ,TO_CHAR( APPROVAL_DATE , 'YYYY-MM-DD HH24:MI:SS' ) APPROVAL_DATE1
              ,UPDATE_USER
              ,UPDATE_DATE
              ,CREATE_USER
              ,CREATE_DATE
              ,TO_CHAR( CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
        FROM   TBL_EXP_APPROVAL
        WHERE  1 = 1
        AND    UUID IN (
                        SELECT APPROVAL_UUID
                        FROM   TBL_EXP_APPROVAL_USER
                        WHERE  1 = 1
                        <if test=" approvalUserId != null and approvalUserId != '' " >
                          AND    APPROVAL_USER_ID = #{approvalUserId}     /* 'windrider' */
                        </if>
                        <if test=" searchType == 'SUSPENSE' " >/* 미결조회 */
                          AND    APPROVAL_TYPE = 'APPR' /* 결재 */
                          AND    STATE IS NULL  /* 'DECISION' */
                        </if>
                       )
        ORDER BY APPROVAL_DATE DESC
    </select>
    
        <!--  결재자 조회 이응규 -->
    <select id="getApprovalUser" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApprovalUser */
        SELECT B.UUID
              ,B.APPROVAL_UUID
              ,B.APPROVAL_USER_ID
              ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = B.APPROVAL_USER_ID) AS APPROVAL_USER_NM
              ,B.STATE
              ,B.APPROVAL_COMMENT
              ,B.UPDATE_USER
              ,B.UPDATE_DATE
              ,B.CREATE_USER
              ,B.CREATE_DATE
              ,TO_CHAR( B.CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
        FROM   TBL_EXP_APPROVAL A
               JOIN TBL_EXP_APPROVAL_USER B
                 ON  1 = 1
                 AND A.UUID= B.APPROVAL_UUID
        WHERE  1 = 1
        <if test=" requestUser != null and requestUser != '' " >
          AND    A.REQUEST_USER = #{requestUser}
        </if><if test=" uuid != null and uuid != '' " >
          AND    A.UUID = #{uuid}
        </if>
        ORDER BY B.CREATE_DATE DESC
    </select>
    
    <!--  결재 조회 이응규 -->
    <select id="getApproval" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /* approval.getApproval */
        SELECT UUID
              ,REQUEST_USER
              ,(SELECT USER_NM FROM   TBL_EXP_USER WHERE  USER_ID = REQUEST_USER) AS REQUEST_USER_NM
              ,TITLE
              ,CONTENTS
              ,STATE
              ,APPROVAL_DATE
              ,TO_CHAR( APPROVAL_DATE , 'YYYY-MM-DD HH24:MI:SS' ) APPROVAL_DATE1
              ,UPDATE_USER
              ,UPDATE_DATE
              ,CREATE_USER
              ,CREATE_DATE
              ,TO_CHAR( CREATE_DATE , 'YYYY-MM-DD HH24:MI:SS' ) CREATE_DATE1 
        FROM  TBL_EXP_APPROVAL
        WHERE 1 = 1
        <if test=" requestUser != null and requestUser != '' " >
          AND   REQUEST_USER = #{requestUser}
        </if>
        <if test=" uuid != null and uuid != '' " >
          AND    UUID = #{uuid}
        </if>
        <if test=" state != null and state != '' " >
          AND    STATE = #{state}
        </if>
        ORDER BY APPROVAL_DATE DESC
    </select>

	<!-- 결재 입력  이응규 -->
    <insert id="insertApproval" parameterType="map" >
        /* approval.insertApproval */
        INSERT INTO TBL_EXP_APPROVAL (
            UUID
           ,REQUEST_USER
           ,TITLE
           ,CONTENTS
           ,STATE
           
           ,APPROVAL_DATE
           ,CREATE_USER
           ,CREATE_DATE
           )
        VALUES(
            #{uuid}
           ,#{requestUser}
           ,#{title}
           ,#{contents}
           ,#{state}
           
           ,(TO_DATE(#{approvalDate} , 'yyyy/mm/dd hh24:mi:ss') )
           ,#{createUser}
           ,(TO_DATE(#{createDate} , 'yyyy/mm/dd hh24:mi:ss') )
           )   
    </insert>
    
    <!-- 결재자 입력  이응규 -->
    <insert id="insertApprovalUser" parameterType="map" >
        /* approval.insertApprovalUser */
        INSERT INTO TBL_EXP_APPROVAL_USER (
             UUID
            ,APPROVAL_UUID
            ,APPROVAL_USER_ID
            ,APPROVAL_TYPE
            ,STATE
            
            ,APPROVAL_COMMENT
            ,CREATE_USER
            ,CREATE_DATE
           )
        VALUES(
            
             #{uuid}
            ,#{approvalUuid}
            ,#{approvalUserId}
            ,#{apprType}
            ,#{state}
            
            ,#{approvalComment}
           ,#{createUser}
           ,(TO_DATE(#{createDate} , 'yyyy/mm/dd hh24:mi:ss') )
           )    
    </insert>
</mapper>
