<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dashboardCorPerformance">

	<cache />
	
	<!-- 매출액 순위, 영업이익별 순위 -->
    <select id="getSalesRanking" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getSalesRanking */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM3
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                SELECT B.SP_CSTM_ID
                      ,B.STORE_ID
                      ,B.STORE_NM
                      ,B.STORE_NM3
                      ,SUM(A.AMOUNT)         AS AMOUNT
                      ,SUM(A.AMOUNT)/1000000 AS AMOUNT1
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.YEAR       = #{year}
                AND    A.SUBJECT    = #{subject}
                GROUP BY B.SP_CSTM_ID
                        ,B.STORE_ID
                        ,B.STORE_NM
                        ,B.STORE_NM3
                ORDER BY  SUM(A.AMOUNT) DESC
               )
        WHERE  1 = 1
    </select>

    <sql id="getSalesRanking_bak_body">
        SELECT ROW_NUMBER() OVER (ORDER BY AMOUNT DESC) AS RN
              ,SP_CSTM_ID
              ,REGION
              ,REGION_NM
              ,YEAR
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                    SELECT B.SP_CSTM_ID
                          ,B.REGION
                          ,GET_CODE_NM('STORE_REGION', B.REGION) AS REGION_NM
                          ,A.YEAR
                          ,SUM(A.AMOUNT)           AS AMOUNT
                          ,SUM(A.AMOUNT)/100000000 AS AMOUNT1
                    FROM   TBL_EXP_STORE_FINANCIAL A
                           JOIN TBL_EXP_STORE_INFO B
                             ON  1 = 1
                             AND A.SP_CSTM_ID = B.SP_CSTM_ID
                             AND A.STORE_ID   = B.STORE_ID
                    WHERE  1 = 1
                    AND    A.SP_CSTM_ID = #{parm.spCstmId}
                    AND    A.YEAR       = #{parm.year}
                    GROUP BY B.SP_CSTM_ID
                            ,B.REGION
                            ,GET_CODE_NM('STORE_REGION', B.REGION)
                            ,A.YEAR
               )
        WHERE  1 = 1
    </sql>  

    <select id="getSalesRanking_bak" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getSalesRanking */
        <include refid="getSalesRanking_bak_body"/>
        ORDER BY AMOUNT 
    </select>
    
    <select id="getSalesRanking_bak_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getSalesRanking_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getSalesRanking_bak_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getSalesRanking_bak_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getSalesRanking_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getSalesRanking_bak_body"/>
        ORDER BY AMOUNT
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <select id="getMonthAccrue" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getMonthAccrue */
        WITH STORE_FINANCIAL AS (
            SELECT MONTH
                  ,SUBJECT
                  ,SUM(AMOUNT) AS AMOUNT
            FROM   TBL_EXP_STORE_FINANCIAL
            WHERE  1 = 1
            AND    SUBJECT IN ('SUBJECT_001','SUBJECT_003','SUBJECT_010','SUBJECT_005') 
            AND    SP_CSTM_ID = #{spCstmId}
            AND    YEAR = #{year}
            GROUP BY MONTH
                    ,SUBJECT
            ORDER BY MONTH
                    ,SUBJECT
        )
		SELECT MONTH
		      ,SUBJECT
		      ,AMOUNT
		FROM   (
		        SELECT SUBJECT, '01' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01') GROUP BY SUBJECT, '01' UNION ALL
		        SELECT SUBJECT, '02' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02') GROUP BY SUBJECT, '02' UNION ALL
		        SELECT SUBJECT, '03' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03') GROUP BY SUBJECT, '03' UNION ALL
		        SELECT SUBJECT, '04' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04') GROUP BY SUBJECT, '04' UNION ALL
		        SELECT SUBJECT, '05' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05') GROUP BY SUBJECT, '05' UNION ALL
		        SELECT SUBJECT, '06' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06') GROUP BY SUBJECT, '06' UNION ALL
		        SELECT SUBJECT, '07' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07') GROUP BY SUBJECT, '07' UNION ALL
		        SELECT SUBJECT, '08' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08') GROUP BY SUBJECT, '08' UNION ALL
		        SELECT SUBJECT, '09' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09') GROUP BY SUBJECT, '09' UNION ALL
		        SELECT SUBJECT, '10' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10') GROUP BY SUBJECT, '10' UNION ALL
		        SELECT SUBJECT, '11' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10','11') GROUP BY SUBJECT, '11' UNION ALL
		        SELECT SUBJECT, '12' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10','11','12') GROUP BY SUBJECT, '12'
		        ) A
		ORDER BY MONTH
		        ,SUBJECT
    </select>
    
    <select id="getMonthSales" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getMonthSales */
        SELECT MONTH
              ,SUBJECT
              ,SUM(AMOUNT) AS AMOUNT
        FROM   TBL_EXP_STORE_FINANCIAL
        WHERE  1 = 1
        AND    SUBJECT IN ('SUBJECT_001','SUBJECT_003','SUBJECT_010','SUBJECT_005') 
        AND    SP_CSTM_ID = #{spCstmId}
        AND    YEAR = #{year}
        GROUP BY MONTH
                ,SUBJECT
        ORDER BY MONTH
                ,SUBJECT
    </select>
    
    <select id="SalesAndGoalSales" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.SalesAndGoalSales */
        WITH SALES_GOAL AS (
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '01' AS MONTH, MONTH1  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '02' AS MONTH, MONTH2  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '03' AS MONTH, MONTH3  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '04' AS MONTH, MONTH4  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '05' AS MONTH, MONTH5  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '06' AS MONTH, MONTH6  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '07' AS MONTH, MONTH7  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '08' AS MONTH, MONTH8  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '09' AS MONTH, MONTH9  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '10' AS MONTH, MONTH10 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '11' AS MONTH, MONTH11 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '12' AS MONTH, MONTH12 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} 
                )
        SELECT A.SP_CSTM_ID
              ,A.STORE_ID
              ,C.STORE_NM3 
              ,SUM(A.AMOUNT)   AS AMOUNT
              ,SUM(B.AMOUNT)   AS AMOUNT_GOAL
        FROM   TBL_EXP_STORE_FINANCIAL A
               JOIN  SALES_GOAL B
                 ON  1 = 1
                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                 AND A.STORE_ID = B.STORE_ID
                 AND A.YEAR = B.YEAR
                 AND A.MONTH = B.MONTH
               JOIN TBL_EXP_STORE_INFO C
                 ON  1 = 1
                 AND A.SP_CSTM_ID = C.SP_CSTM_ID
                 AND A.STORE_ID   = C.STORE_ID  
        WHERE  1 = 1
        AND    A.SUBJECT = 'SUBJECT_001' 
        AND    A.SP_CSTM_ID = #{spCstmId}
        GROUP BY A.SP_CSTM_ID
                ,A.STORE_ID
                ,C.STORE_NM3
        ORDER BY A.SP_CSTM_ID
                ,A.STORE_ID
    </select>
    
    <select id="getComparisonPreMonth" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getComparisonPreMonth */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM3
              ,NVL(MAX(AMOUNT), 0) AS AMOUNT
              ,NVL(MAX(AMOUNT_PREVIOUS), 0) AS AMOUNT_PREVIOUS
        FROM   (
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,C.STORE_NM3 
                      ,A.AMOUNT
                      ,NULL      AS AMOUNT_previous
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO C
                         ON  1 = 1
                         AND A.SP_CSTM_ID = C.SP_CSTM_ID
                         AND A.STORE_ID   = C.STORE_ID  
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.SUBJECT = 'SUBJECT_001' 
                AND    A.YEAR    = #{year}
                AND    A.MONTH   = #{month}
                UNION ALL
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,C.STORE_NM3 
                      ,NULL          AS AMOUNT
                      ,A.AMOUNT      AS AMOUNT_previous
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO C
                         ON  1 = 1
                         AND A.SP_CSTM_ID = C.SP_CSTM_ID
                         AND A.STORE_ID   = C.STORE_ID  
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.SUBJECT = 'SUBJECT_001' 
                AND    A.YEAR    = #{preYear}
                AND    A.MONTH   = #{preMonth}
                        ) A
        GROUP BY SP_CSTM_ID
                ,STORE_ID
                ,STORE_NM3  
        ORDER BY SP_CSTM_ID
                ,STORE_ID
    </select>
    
    
    <sql id="getFinancial_body">
        SELECT ROW_NUMBER() OVER (ORDER BY A.STORE_ID,A.YEAR,A.MONTH DESC) AS RN
              ,A.SP_CSTM_ID
              ,A.STORE_ID
              ,A.YEAR
              ,A.MONTH
              ,C.STORE_NM3
              ,A.SUBJECT
              ,GET_CODE_NM('FINANCIAL_SUBJECT', A.SUBJECT) AS SUBJECT_NM 
              ,A.AMOUNT AS AMOUNT
        FROM   TBL_EXP_STORE_FINANCIAL A
               JOIN TBL_EXP_STORE_INFO C
                 ON  1 = 1
                 AND A.SP_CSTM_ID = C.SP_CSTM_ID
                 AND A.STORE_ID   = C.STORE_ID  
        WHERE  1 = 1
        AND    A.SP_CSTM_ID = #{parm.spCstmId}
        <if test=" !'ALL'.equals(parm.storeId) ">
            AND    A.STORE_ID = #{parm.storeId} 
        </if>
        AND    A.SUBJECT = #{parm.subject} 
        AND    A.YEAR    = #{parm.year}
        AND    A.MONTH   = #{parm.month}
    </sql>  
    
    <!-- 매출액 순위, 영업이익별 순위 -->
    <select id="getFinancial" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getFinancial */
        <include refid="getFinancial_body"/>
        ORDER BY  A.SP_CSTM_ID
              ,A.YEAR
              ,A.MONTH
              ,A.STORE_ID
              ,C.STORE_NM3 
    </select>
    
    <select id="getFinancial_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getFinancial_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getFinancial_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getFinancial_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getFinancial_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getFinancial_body"/>
        ORDER BY  A.SP_CSTM_ID
              ,A.YEAR
              ,A.MONTH
              ,A.STORE_ID
              ,C.STORE_NM3 
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <!-- 매장정보 조회 -->
    <select id="getStore" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getStore */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM1
              ,STORE_NM2
              ,STORE_NM3
              ,STORE_ID  AS CODE_ID
              ,STORE_NM3 AS CODE_NM
              ,STORE_NM4
              ,STORE_NM5
              ,ADDRESS
              ,STORE_MANAGER_NM
              ,REGION
              ,DEPARTMENT_CHARGE
              ,TO_CHAR( CONTRACT_DATE , 'YYYY-MM-DD')  AS CONTRACT_DATE 
              ,TO_CHAR( OPENING_DAY , 'YYYY-MM-DD')    AS OPENING_DAY
              ,TO_CHAR( TRANSFER_DAY , 'YYYY-MM-DD')   AS TRANSFER_DAY
              ,TO_CHAR( CLOSING_DATE , 'YYYY-MM-DD')   AS CLOSING_DATE
              ,FRANCHISE_STORE
              ,NOTE
              ,TB_ROTATION
              ,TB_ROTATION_GOAL
              ,START_MARKETING
              ,SUPERVISOR
              ,UPDATE_USER
              ,UPDATE_DATE
        FROM   TBL_EXP_STORE_INFO
        WHERE  1 = 1
        AND    SP_CSTM_ID = #{spCstmId}
        <if test=" startDate != null and startDate != '' and endDate != null and endDate != '' " >
            AND    OPENING_DAY BETWEEN TO_DATE( #{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        </if>
                
        ORDER BY STORE_NM3 
    </select>
    
    <sql id="getStorePage_body">
        SELECT ROW_NUMBER() OVER (ORDER BY  SP_CSTM_ID, STORE_ID) AS RN
              ,SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM1
              ,STORE_NM2
              ,STORE_NM3
              ,STORE_ID  AS CODE_ID
              ,STORE_NM3 AS CODE_NM
              ,STORE_NM4
              ,STORE_NM5
              ,ADDRESS
              ,STORE_MANAGER_NM
              ,REGION
              ,DEPARTMENT_CHARGE
              ,TO_CHAR( CONTRACT_DATE , 'YYYY-MM-DD')  AS CONTRACT_DATE 
              ,TO_CHAR( OPENING_DAY , 'YYYY-MM-DD')    AS OPENING_DAY
              ,TO_CHAR( TRANSFER_DAY , 'YYYY-MM-DD')   AS TRANSFER_DAY
              ,TO_CHAR( CLOSING_DATE , 'YYYY-MM-DD')   AS CLOSING_DATE
              ,FRANCHISE_STORE
              ,NOTE
              ,TB_ROTATION
              ,TB_ROTATION_GOAL
              ,START_MARKETING
              ,SUPERVISOR
              ,UPDATE_USER
              ,UPDATE_DATE
        FROM   TBL_EXP_STORE_INFO
        WHERE  1 = 1
        <if test=" parm.dateStart != null and parm.dateStart != '' and parm.dateEnd != null and parm.dateEnd != '' " >
            AND    OPENING_DAY BETWEEN TO_DATE( #{parm.dateStart}, 'YYYY-MM-DD') AND TO_DATE(#{parm.dateEnd}, 'YYYY-MM-DD')
        </if>
        <if test=" !'ALL'.equals(parm.region) ">
            AND    REGION = #{parm.region} 
        </if>
        <if test=" !'ALL'.equals(parm.supervisor) ">
            AND    supervisor = #{parm.supervisor} 
        </if>
    </sql>  
    <select id="getStorePage" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getStorePage */
        <include refid="getStorePage_body"/>
        ORDER BY STORE_NM3 
    </select>
    
    <select id="getStorePage_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getStorePage_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getStorePage_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getStorePage_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getStorePage_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getStorePage_body"/>
        ORDER BY STORE_NM3
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <select id="getRegionsRanking" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getRegionsRanking */
        SELECT SP_CSTM_ID
              ,REGION
              ,REGION_NM
              ,YEAR
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                    SELECT B.SP_CSTM_ID
                          ,B.REGION
                          ,GET_CODE_NM('STORE_REGION', B.REGION) AS REGION_NM
                          ,A.YEAR
                          ,SUM(A.AMOUNT)           AS AMOUNT
                          ,SUM(A.AMOUNT)/100000000 AS AMOUNT1
                    FROM   TBL_EXP_STORE_FINANCIAL A
                           JOIN TBL_EXP_STORE_INFO B
                             ON  1 = 1
                             AND A.SP_CSTM_ID = B.SP_CSTM_ID
                             AND A.STORE_ID   = B.STORE_ID
                    WHERE  1 = 1
                    AND    A.SP_CSTM_ID = #{spCstmId}
                    AND    A.YEAR       = #{year}
                    GROUP BY B.SP_CSTM_ID
                            ,B.REGION
                            ,GET_CODE_NM('STORE_REGION', B.REGION)
                            ,A.YEAR
                    ORDER BY  SUM(A.AMOUNT) DESC
               )
        WHERE  1 = 1
    </select>
    
</mapper>
