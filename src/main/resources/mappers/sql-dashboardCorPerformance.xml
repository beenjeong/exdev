<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dashboardCorPerformance">

	<cache />
	
	<!-- 매출액 순위, 영업이익별 순위 -->
    <select id="getSalesRanking" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getSalesRanking */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM3
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                SELECT B.SP_CSTM_ID
                      ,B.STORE_ID
                      ,B.STORE_NM
                      ,B.STORE_NM3
                      ,SUM(A.AMOUNT)         AS AMOUNT
                      ,SUM(A.AMOUNT)/1000000 AS AMOUNT1
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.YEAR       = #{year}
                AND    A.SUBJECT    = #{subject}
                GROUP BY B.SP_CSTM_ID
                        ,B.STORE_ID
                        ,B.STORE_NM
                        ,B.STORE_NM3
                ORDER BY  SUM(A.AMOUNT) DESC
               )
        WHERE  1 = 1
    </select>

    <sql id="getSalesRanking_bak_body">
        SELECT ROW_NUMBER() OVER (ORDER BY AMOUNT DESC) AS RN
              ,SP_CSTM_ID
              ,REGION
              ,REGION_NM
              ,YEAR
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                    SELECT B.SP_CSTM_ID
                          ,B.REGION
                          ,GET_CODE_NM('STORE_REGION', B.REGION) AS REGION_NM
                          ,A.YEAR
                          ,SUM(A.AMOUNT)           AS AMOUNT
                          ,SUM(A.AMOUNT)/100000000 AS AMOUNT1
                    FROM   TBL_EXP_STORE_FINANCIAL A
                           JOIN TBL_EXP_STORE_INFO B
                             ON  1 = 1
                             AND A.SP_CSTM_ID = B.SP_CSTM_ID
                             AND A.STORE_ID   = B.STORE_ID
                    WHERE  1 = 1
                    AND    A.SP_CSTM_ID = #{parm.spCstmId}
                    AND    A.YEAR       = #{parm.year}
                    GROUP BY B.SP_CSTM_ID
                            ,B.REGION
                            ,GET_CODE_NM('STORE_REGION', B.REGION)
                            ,A.YEAR
               )
        WHERE  1 = 1
    </sql>  

    <select id="getSalesRanking_bak" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getSalesRanking */
        <include refid="getSalesRanking_bak_body"/>
        ORDER BY AMOUNT 
    </select>
    
    <select id="getSalesRanking_bak_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getSalesRanking_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getSalesRanking_bak_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getSalesRanking_bak_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getSalesRanking_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getSalesRanking_bak_body"/>
        ORDER BY AMOUNT
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <select id="getMonthAccrue" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getMonthAccrue */
        WITH STORE_FINANCIAL AS (
            SELECT MONTH
                  ,SUBJECT
                  ,SUM(AMOUNT) AS AMOUNT
            FROM   TBL_EXP_STORE_FINANCIAL
            WHERE  1 = 1
            AND    SUBJECT IN ('SUBJECT_001','SUBJECT_003','SUBJECT_010','SUBJECT_005') 
            AND    SP_CSTM_ID = #{spCstmId}
            AND    YEAR = #{year}
            GROUP BY MONTH
                    ,SUBJECT
            ORDER BY MONTH
                    ,SUBJECT
        )
		SELECT MONTH
		      ,SUBJECT
		      ,AMOUNT
		FROM   (
		        SELECT SUBJECT, '01' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01') GROUP BY SUBJECT, '01' UNION ALL
		        SELECT SUBJECT, '02' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02') GROUP BY SUBJECT, '02' UNION ALL
		        SELECT SUBJECT, '03' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03') GROUP BY SUBJECT, '03' UNION ALL
		        SELECT SUBJECT, '04' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04') GROUP BY SUBJECT, '04' UNION ALL
		        SELECT SUBJECT, '05' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05') GROUP BY SUBJECT, '05' UNION ALL
		        SELECT SUBJECT, '06' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06') GROUP BY SUBJECT, '06' UNION ALL
		        SELECT SUBJECT, '07' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07') GROUP BY SUBJECT, '07' UNION ALL
		        SELECT SUBJECT, '08' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08') GROUP BY SUBJECT, '08' UNION ALL
		        SELECT SUBJECT, '09' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09') GROUP BY SUBJECT, '09' UNION ALL
		        SELECT SUBJECT, '10' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10') GROUP BY SUBJECT, '10' UNION ALL
		        SELECT SUBJECT, '11' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10','11') GROUP BY SUBJECT, '11' UNION ALL
		        SELECT SUBJECT, '12' AS MONTH, SUM(AMOUNT) AS AMOUNT FROM STORE_FINANCIAL WHERE MONTH IN ('01','02','03','04','05','06','07','08','09','10','11','12') GROUP BY SUBJECT, '12'
		        ) A
		ORDER BY MONTH
		        ,SUBJECT
    </select>
    
    <select id="getMonthSales" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getMonthSales */
        SELECT MONTH
              ,SUBJECT
              ,SUM(AMOUNT) AS AMOUNT
        FROM   TBL_EXP_STORE_FINANCIAL
        WHERE  1 = 1
        AND    SUBJECT IN ('SUBJECT_001','SUBJECT_003','SUBJECT_010','SUBJECT_005') 
        AND    SP_CSTM_ID = #{spCstmId}
        AND    YEAR = #{year}
        GROUP BY MONTH
                ,SUBJECT
        ORDER BY MONTH
                ,SUBJECT
    </select>
    
    <select id="SalesAndGoalSales" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.SalesAndGoalSales */
        WITH SALES_GOAL AS (
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '01' AS MONTH, MONTH1  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '02' AS MONTH, MONTH2  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '03' AS MONTH, MONTH3  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '04' AS MONTH, MONTH4  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '05' AS MONTH, MONTH5  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '06' AS MONTH, MONTH6  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '07' AS MONTH, MONTH7  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '08' AS MONTH, MONTH8  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '09' AS MONTH, MONTH9  AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '10' AS MONTH, MONTH10 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '11' AS MONTH, MONTH11 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} UNION ALL
                SELECT SP_CSTM_ID, STORE_ID, YEAR, '12' AS MONTH, MONTH12 AS AMOUNT FROM   TBL_EXP_STORE_SALES_GOAL WHERE SP_CSTM_ID = #{spCstmId} 
                )
        SELECT A.SP_CSTM_ID
              ,A.STORE_ID
              ,C.STORE_NM3 
              ,SUM(A.AMOUNT)   AS AMOUNT
              ,SUM(B.AMOUNT)   AS AMOUNT_GOAL
        FROM   TBL_EXP_STORE_FINANCIAL A
               JOIN  SALES_GOAL B
                 ON  1 = 1
                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                 AND A.STORE_ID = B.STORE_ID
                 AND A.YEAR = B.YEAR
                 AND A.MONTH = B.MONTH
               JOIN TBL_EXP_STORE_INFO C
                 ON  1 = 1
                 AND A.SP_CSTM_ID = C.SP_CSTM_ID
                 AND A.STORE_ID   = C.STORE_ID  
        WHERE  1 = 1
        AND    A.SUBJECT = 'SUBJECT_001' 
        AND    A.SP_CSTM_ID = #{spCstmId}
        GROUP BY A.SP_CSTM_ID
                ,A.STORE_ID
                ,C.STORE_NM3
        ORDER BY A.SP_CSTM_ID
                ,A.STORE_ID
    </select>
    
    <select id="getComparisonPreMonth" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getComparisonPreMonth */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM3
              ,NVL(MAX(AMOUNT), 0) AS AMOUNT
              ,NVL(MAX(AMOUNT_PREVIOUS), 0) AS AMOUNT_PREVIOUS
        FROM   (
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,C.STORE_NM3 
                      ,A.AMOUNT
                      ,NULL      AS AMOUNT_previous
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO C
                         ON  1 = 1
                         AND A.SP_CSTM_ID = C.SP_CSTM_ID
                         AND A.STORE_ID   = C.STORE_ID  
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.SUBJECT = 'SUBJECT_001' 
                AND    A.YEAR    = #{year}
                AND    A.MONTH   = #{month}
                UNION ALL
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,C.STORE_NM3 
                      ,NULL          AS AMOUNT
                      ,A.AMOUNT      AS AMOUNT_previous
                FROM   TBL_EXP_STORE_FINANCIAL A
                       JOIN TBL_EXP_STORE_INFO C
                         ON  1 = 1
                         AND A.SP_CSTM_ID = C.SP_CSTM_ID
                         AND A.STORE_ID   = C.STORE_ID  
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{spCstmId}
                AND    A.SUBJECT = 'SUBJECT_001' 
                AND    A.YEAR    = #{preYear}
                AND    A.MONTH   = #{preMonth}
                        ) A
        GROUP BY SP_CSTM_ID
                ,STORE_ID
                ,STORE_NM3  
        ORDER BY SP_CSTM_ID
                ,STORE_ID
    </select>
    
    
    <sql id="getFinancial_body">
        SELECT ROW_NUMBER() OVER (ORDER BY A.STORE_ID,A.YEAR,A.MONTH DESC) AS RN
              ,A.SP_CSTM_ID
              ,A.STORE_ID
              ,A.YEAR
              ,A.MONTH
              ,C.STORE_NM3
              ,A.SUBJECT
              ,GET_CODE_NM('FINANCIAL_SUBJECT', A.SUBJECT) AS SUBJECT_NM 
              ,A.AMOUNT AS AMOUNT
        FROM   TBL_EXP_STORE_FINANCIAL A
               JOIN TBL_EXP_STORE_INFO C
                 ON  1 = 1
                 AND A.SP_CSTM_ID = C.SP_CSTM_ID
                 AND A.STORE_ID   = C.STORE_ID  
        WHERE  1 = 1
        AND    A.SP_CSTM_ID = #{parm.spCstmId}
        <if test=" !'ALL'.equals(parm.storeId) ">
            AND    A.STORE_ID = #{parm.storeId} 
        </if>
        AND    A.SUBJECT = #{parm.subject} 
        AND    A.YEAR    = #{parm.year}
        AND    A.MONTH   = #{parm.month}
    </sql>  
    
    <!-- 매출액 순위, 영업이익별 순위 -->
    <select id="getFinancial" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getFinancial */
        <include refid="getFinancial_body"/>
        ORDER BY  A.SP_CSTM_ID
              ,A.YEAR
              ,A.MONTH
              ,A.STORE_ID
              ,C.STORE_NM3 
    </select>
    
    <select id="getFinancial_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getFinancial_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getFinancial_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getFinancial_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getFinancial_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getFinancial_body"/>
        ORDER BY  A.SP_CSTM_ID
              ,A.YEAR
              ,A.MONTH
              ,A.STORE_ID
              ,C.STORE_NM3 
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <!-- 매장정보 조회 -->
    <select id="getStore" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getStore */
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM1
              ,STORE_NM2
              ,STORE_NM3
              ,STORE_ID  AS CODE_ID
              ,STORE_NM3 AS CODE_NM
              ,STORE_NM4
              ,STORE_NM5
              ,ADDRESS
              ,STORE_MANAGER_NM
              ,REGION
              ,DEPARTMENT_CHARGE
              ,TO_CHAR( CONTRACT_DATE , 'YYYY-MM-DD')  AS CONTRACT_DATE 
              ,TO_CHAR( OPENING_DAY , 'YYYY-MM-DD')    AS OPENING_DAY
              ,TO_CHAR( TRANSFER_DAY , 'YYYY-MM-DD')   AS TRANSFER_DAY
              ,TO_CHAR( CLOSING_DATE , 'YYYY-MM-DD')   AS CLOSING_DATE
              ,FRANCHISE_STORE
              ,NOTE
              ,TB_ROTATION
              ,TB_ROTATION_GOAL
              ,START_MARKETING
              ,SUPERVISOR
              ,UPDATE_USER
              ,UPDATE_DATE
        FROM   TBL_EXP_STORE_INFO
        WHERE  1 = 1
        AND    SP_CSTM_ID = #{spCstmId}
        <if test=" startDate != null and startDate != '' and endDate != null and endDate != '' " >
            AND    OPENING_DAY BETWEEN TO_DATE( #{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        </if>
        <if test=" region != null and region != '' ">
            <if test=" !'ALL'.equals(region) ">
               AND    REGION = #{region} 
            </if>        
        </if>        
        ORDER BY STORE_NM3 
    </select>
    
    <sql id="getStorePage_body">
        SELECT ROW_NUMBER() OVER (ORDER BY  SP_CSTM_ID, STORE_ID) AS RN
              ,SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM
              ,STORE_NM1
              ,STORE_NM2
              ,STORE_NM3
              ,STORE_ID  AS CODE_ID
              ,STORE_NM3 AS CODE_NM
              ,STORE_NM4
              ,STORE_NM5
              ,ADDRESS
              ,STORE_MANAGER_NM
              ,REGION
              ,DEPARTMENT_CHARGE
              ,TO_CHAR( CONTRACT_DATE , 'YYYY-MM-DD')  AS CONTRACT_DATE 
              ,TO_CHAR( OPENING_DAY , 'YYYY-MM-DD')    AS OPENING_DAY
              ,TO_CHAR( TRANSFER_DAY , 'YYYY-MM-DD')   AS TRANSFER_DAY
              ,TO_CHAR( CLOSING_DATE , 'YYYY-MM-DD')   AS CLOSING_DATE
              ,FRANCHISE_STORE
              ,NOTE
              ,TB_ROTATION
              ,TB_ROTATION_GOAL
              ,START_MARKETING
              ,SUPERVISOR
              ,UPDATE_USER
              ,UPDATE_DATE
        FROM   TBL_EXP_STORE_INFO
        WHERE  1 = 1
        <if test=" parm.dateStart != null and parm.dateStart != '' and parm.dateEnd != null and parm.dateEnd != '' " >
            AND    OPENING_DAY BETWEEN TO_DATE( #{parm.dateStart}, 'YYYY-MM') AND TO_DATE(#{parm.dateEnd}, 'YYYY-MM')
        </if>
        <if test=" !'ALL'.equals(parm.region) ">
            AND    REGION = #{parm.region} 
        </if>
        <if test=" !'ALL'.equals(parm.supervisor) ">
            AND    SUPERVISOR = #{parm.supervisor} 
        </if>
    </sql>  
    <select id="getStorePage" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getStorePage */
        <include refid="getStorePage_body"/>
        ORDER BY STORE_NM3 
    </select>
    
    <select id="getStorePage_totalCnt" resultType="Integer">
        /* dashboardCorPerformance.getStorePage_totalCnt  */
        <include refid="common.totalWrapStart"/>
        <include refid="getStorePage_body"/>
        <include refid="common.totalWrapEnd"/>
    </select>
    
    <select id="getStorePage_paging" resultType="java.util.HashMap">
        /* dashboardCorPerformance.getStorePage_paging  */
        <include refid="common.pagingWrapStart"/>
        <include refid="getStorePage_body"/>
        ORDER BY STORE_NM3
        <include refid="common.pagingWrapEnd"/>
    </select>
    
    <select id="getRegionsRanking" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getRegionsRanking */
        SELECT SP_CSTM_ID
              ,REGION
              ,REGION_NM
              ,YEAR
              ,AMOUNT
              ,AMOUNT1
        FROM   (
                    SELECT B.SP_CSTM_ID
                          ,B.REGION
                          ,GET_CODE_NM('STORE_REGION', B.REGION) AS REGION_NM
                          ,A.YEAR
                          ,SUM(A.AMOUNT)           AS AMOUNT
                          ,SUM(A.AMOUNT)/100000000 AS AMOUNT1
                    FROM   TBL_EXP_STORE_FINANCIAL A
                           JOIN TBL_EXP_STORE_INFO B
                             ON  1 = 1
                             AND A.SP_CSTM_ID = B.SP_CSTM_ID
                             AND A.STORE_ID   = B.STORE_ID
                    WHERE  1 = 1
                    AND    A.SP_CSTM_ID = #{spCstmId}
                    AND    A.YEAR       = #{year}
                    GROUP BY B.SP_CSTM_ID
                            ,B.REGION
                            ,GET_CODE_NM('STORE_REGION', B.REGION)
                            ,A.YEAR
                    ORDER BY  SUM(A.AMOUNT) DESC
               )
        WHERE  1 = 1
    </select>
    
    <select id="getOpenCloseCnt" resultType="java.util.HashMap" flushCache="true"  useCache="false"> 
        SELECT 'OPEN'  AS TYPE, COUNT(1) AS CNT 
        FROM   TBL_EXP_STORE_INFO 
        WHERE  SP_CSTM_ID = #{spCstmId} 
        AND    TO_CHAR( OPENING_DAY,  'YYYY-MM') = #{seartDate}
        <if test=" !'ALL'.equals(region) ">
            AND    REGION     = #{region} 
        </if> 
        <if test=" !'ALL'.equals(supervisor) ">
            AND    SUPERVISOR = #{supervisor} 
        </if> 
        UNION ALL
        SELECT 'CLOSE' AS TYPE, COUNT(1) AS CNT 
        FROM   TBL_EXP_STORE_INFO 
        WHERE  SP_CSTM_ID = #{spCstmId} 
        AND    TO_CHAR( CLOSING_DATE, 'YYYY-MM') = #{seartDate} 
        <if test=" !'ALL'.equals(region) ">
            AND    REGION     = #{region} 
        </if> 
        <if test=" !'ALL'.equals(supervisor) ">
            AND    SUPERVISOR = #{supervisor} 
        </if>
        UNION ALL 
        SELECT 'ALL'   AS TYPE, COUNT(1) AS CNT 
        FROM   TBL_EXP_STORE_INFO 
        WHERE  SP_CSTM_ID = #{spCstmId} 
        <if test=" !'ALL'.equals(region) ">
            AND    REGION     = #{region} 
        </if> 
        <if test=" !'ALL'.equals(supervisor) ">
            AND    SUPERVISOR = #{supervisor} 
        </if>
        AND    TO_CHAR( OPENING_DAY,  'YYYY-MM') <![CDATA[<=]]> #{seartDate} 
        AND    CLOSING_DATE IS NULL
    </select>
    
    <!--  -->
    <select id="getOpenCloseCntSummary" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getOpenCloseCntSummary */
		SELECT SUM(ALL_CNT)   AS ALL_CNT
		      ,SUM(CLOSE_CNT) AS CLOSE_CNT
		      ,SUM(ALL_CNT) - SUM(CLOSE_CNT) AS OPEN_CNT
		FROM   (
		        SELECT COUNT(1) AS ALL_CNT
		             , 0        AS CLOSE_CNT
		        FROM TBL_EXP_STORE_INFO 
		        WHERE SP_CSTM_ID = #{sessionVo.spCstmId}
		        <if test=" !'ALL'.equals(region) ">
		            AND    REGION     = #{region} 
		        </if> 
		        <if test=" !'ALL'.equals(supervisor) ">
		            AND    SUPERVISOR = #{supervisor} 
		        </if>
		        UNION ALL
		        SELECT 0        AS ALL_CNT 
		              ,COUNT(1) AS CLOSE_CNT 
		        FROM TBL_EXP_STORE_INFO 
		        WHERE SP_CSTM_ID = #{sessionVo.spCstmId}
                <if test=" !'ALL'.equals(region) ">
                    AND    REGION     = #{region} 
                </if> 
                <if test=" !'ALL'.equals(supervisor) ">
                    AND    SUPERVISOR = #{supervisor} 
                </if>
		        AND CLOSING_DATE IS NOT NULL
		        )
    </select>
    
    <select id="getRegionCnt" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getRegionCnt */
        SELECT REGION
		      ,NVL(REGION_NM,'없음') AS  REGION_NM
		      ,CNT 
		FROM   (
		        SELECT REGION
		              ,GET_CODE_NM('STORE_REGION', REGION)      AS REGION_NM
		              ,COUNT(1) AS CNT 
		        FROM TBL_EXP_STORE_INFO 
		        WHERE SP_CSTM_ID = #{sessionVo.spCstmId}
		        AND CLOSING_DATE IS  NULL
		        GROUP BY REGION
		        )
		ORDER BY CNT DESC 
    </select>

    <select id="getGoalAchieveRatio" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getGoalAchieveRatio */
        SELECT  CASE #{month}  WHEN '01'  THEN ROUND( (B.AMOUNT/A.MONTH1) *100, 2) 
                               WHEN '02'  THEN ROUND( (B.AMOUNT/A.MONTH2) *100, 2)
                               WHEN '03'  THEN ROUND( (B.AMOUNT/A.MONTH3) *100, 2)
                               WHEN '04'  THEN ROUND( (B.AMOUNT/A.MONTH4) *100, 2)
                               WHEN '05'  THEN ROUND( (B.AMOUNT/A.MONTH5) *100, 2)
                               WHEN '06'  THEN ROUND( (B.AMOUNT/A.MONTH6) *100, 2)
                               WHEN '07'  THEN ROUND( (B.AMOUNT/A.MONTH7) *100, 2)
                               WHEN '08'  THEN ROUND( (B.AMOUNT/A.MONTH8) *100, 2)
                               WHEN '09'  THEN ROUND( (B.AMOUNT/A.MONTH9) *100, 2)
                               WHEN '10'  THEN ROUND( (B.AMOUNT/A.MONTH10) *100, 2)
                               WHEN '11'  THEN ROUND( (B.AMOUNT/A.MONTH11) *100, 2)
                               WHEN '12'  THEN ROUND( (B.AMOUNT/A.MONTH12) *100, 2)
                               ELSE 0
                END AS ACHIEVE
        FROM   (
                /* 매장별 목표 매출*/
                SELECT SUM(B.MONTH1)      AS MONTH1
                      ,SUM(B.MONTH2)      AS MONTH2 
                      ,SUM(B.MONTH3)      AS MONTH3 
                      ,SUM(B.MONTH4)      AS MONTH4 
                      ,SUM(B.MONTH5)      AS MONTH5 
                      ,SUM(B.MONTH6)      AS MONTH6 
                      ,SUM(B.MONTH7)      AS MONTH7 
                      ,SUM(B.MONTH8)      AS MONTH8 
                      ,SUM(B.MONTH9)      AS MONTH9 
                      ,SUM(B.MONTH10)     AS MONTH10
                      ,SUM(B.MONTH11)     AS MONTH11
                      ,SUM(B.MONTH12)     AS MONTH12
                FROM   TBL_EXP_STORE_INFO A
                       JOIN TBL_EXP_STORE_SALES_GOAL B
                           ON  1 = 1
                           AND A.SP_CSTM_ID = B.SP_CSTM_ID
                           AND A.STORE_ID   = B.STORE_ID
                           AND B.YEAR = #{year} 
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                <if test=" !'ALL'.equals(region) ">
                    AND    A.REGION =  #{region} 
                </if>
                <if test=" !'ALL'.equals(store) ">
                    AND    STORE_ID = #{store} 
                </if>
                <if test=" !'ALL'.equals(supervisor) ">
                    AND    A.SUPERVISOR = #{supervisor} 
                </if>
                ) A
               ,(
                    SELECT SUM(B.AMOUNT) AS AMOUNT
                    FROM   TBL_EXP_STORE_INFO A
                           JOIN TBL_EXP_STORE_FINANCIAL B
                             ON  1 = 1
                             AND A.SP_CSTM_ID = B.SP_CSTM_ID
                             AND A.STORE_ID   = B.STORE_ID
                             AND B.YEAR       = #{year}
                             AND B.MONTH      = #{month} 
                    AND    SUBJECT = 'SUBJECT_001'
                    WHERE  1 = 1
                    AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                    <if test=" !'ALL'.equals(region) ">
                        AND    A.REGION =  #{region} 
                    </if>
                    <if test=" !'ALL'.equals(store) ">
                        AND    A.STORE_ID = #{store} 
                    </if>
                    <if test=" !'ALL'.equals(supervisor) ">
                      AND    A.SUPERVISOR = #{supervisor} 
                    </if>
                ) B
    </select>

    <select id="getTbRotationRatio" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getTbRotationRatio */
        SELECT ROUND( AVG(NVL(RECEIPT_CNT2, 0)) ,2)  AS TB_ROTATION_GOAL
        FROM   (
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,A.TB_ROTATION
                      ,A.TB_ROTATION_GOAL
                      ,B.YEAR
                      ,B.MONTH
                      ,SUM(B.RECEIPT_CNT) AS RECEIPT_CNT
                      ,ROUND(SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT),2) AS RECEIPT_CNT2
                FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                       JOIN TBL_EXP_STORE_SALES B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{year}
                         AND B.MONTH      = #{month} 
                       JOIN (
                                SELECT SP_CSTM_ID
                                      ,STORE_ID
                                      ,YEAR
                                      ,MONTH
                                      ,COUNT(1) DAY_CNT
                                FROM   TBL_EXP_STORE_SALES
                                WHERE  1 = 1
                                AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                AND    YEAR       = #{year}
                                AND    MONTH      = #{month} 
                                AND    RECEIPT_CNT IS NOT NULL
                                AND    RECEIPT_CNT != 0
                                GROUP BY SP_CSTM_ID
                                        ,STORE_ID
                                        ,YEAR
                                        ,MONTH
                            ) C
                         ON  1 = 1
                         AND B.SP_CSTM_ID = C.SP_CSTM_ID
                         AND B.STORE_ID   = C.STORE_ID
                         AND B.YEAR       = C.YEAR
                         AND B.MONTH      = C.MONTH
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                AND    A.TB_ROTATION IS NOT NULL
                GROUP BY A.SP_CSTM_ID
                        ,A.STORE_ID
                        ,A.TB_ROTATION
                        ,A.TB_ROTATION_GOAL
                        ,B.YEAR
                        ,B.MONTH
                ORDER BY A.SP_CSTM_ID
                        ,A.STORE_ID  
                )
    </select> 
    
    <select id="getGrowthRate" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getGrowthRate */
        SELECT CASE WHEN MAX(A.AMOUNT1) != 0 AND MAX(A.AMOUNT2) !=  0 THEN ROUND((MAX(A.AMOUNT1)/MAX(A.AMOUNT2)) * 100,2)
                    ELSE 0
               END AS GROWTH_RATE
        FROM   (
                /* 조회년도 */
                SELECT SUM(B.AMOUNT) AS AMOUNT1
                      ,0             AS AMOUNT2
                FROM   TBL_EXP_STORE_INFO A
                       JOIN TBL_EXP_STORE_FINANCIAL B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{year}
                         AND B.MONTH      = #{month} 
                AND    SUBJECT = 'SUBJECT_001'
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                UNION ALL
                /* 조회 전년도 */
                SELECT 0             AS AMOUNT1
                      ,SUM(B.AMOUNT) AS AMOUNT2
                FROM   TBL_EXP_STORE_INFO A
                       JOIN TBL_EXP_STORE_FINANCIAL B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{previousYear}
                         AND B.MONTH      = #{month} 
                AND    SUBJECT = 'SUBJECT_001'
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                ) A   
    </select>    

    <select id="getGoalAchieveRatioRank" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getGoalAchieveRatioRank */
        SELECT A.SP_CSTM_ID
              ,A.STORE_ID
              ,A.STORE_NM3
              ,A.YEAR
              ,A.MONTH
              ,A.GOLE_AMOUNT
              ,A.AMOUNT
              ,A.ACHIEVE_RATIO
        FROM   (
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,A.STORE_NM3
                      ,A.YEAR
                      ,A.MONTH
                      ,A.GOLE_AMOUNT
                      ,B.AMOUNT
                      ,ROUND( ((B.AMOUNT /  A.GOLE_AMOUNT) * 100) ,2) AS ACHIEVE_RATIO
                FROM   (
                            SELECT B.SP_CSTM_ID
                                  ,B.STORE_ID
                                  ,A.STORE_NM3
                                  ,B.YEAR
                                  ,#{month} AS MONTH
                                  ,CASE #{month}  WHEN '01'  THEN B.MONTH1
                                                  WHEN '02'  THEN B.MONTH2
                                                  WHEN '03'  THEN B.MONTH3
                                                  WHEN '04'  THEN B.MONTH4
                                                  WHEN '05'  THEN B.MONTH5
                                                  WHEN '06'  THEN B.MONTH6
                                                  WHEN '07'  THEN B.MONTH7
                                                  WHEN '08'  THEN B.MONTH8
                                                  WHEN '09'  THEN B.MONTH9
                                                  WHEN '10'  THEN B.MONTH10
                                                  WHEN '11'  THEN B.MONTH11
                                                  WHEN '12'  THEN B.MONTH12
                                                  ELSE 0
                                    END AS GOLE_AMOUNT
                            FROM   TBL_EXP_STORE_INFO A
                                   JOIN TBL_EXP_STORE_SALES_GOAL B
                                       ON  1 = 1
                                       AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                       AND A.STORE_ID   = B.STORE_ID
                                       AND B.MONTH1     IS NOT NULL
                                       AND B.YEAR       = #{year}
                            WHERE  1 = 1
                            AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                            <if test=" !'ALL'.equals(region) ">
                                AND    A.REGION =  #{region} 
                            </if>
                            <if test=" !'ALL'.equals(store) ">
                                AND    STORE_ID = #{store} 
                            </if>
                            <if test=" !'ALL'.equals(supervisor) ">
                                AND    A.SUPERVISOR = #{supervisor} 
                            </if>
                        ) A
                        JOIN (  
                            SELECT B.SP_CSTM_ID
                                  ,B.STORE_ID
                                  ,A.STORE_NM3
                                  ,B.YEAR
                                  ,B.MONTH
                                  ,B.AMOUNT AS AMOUNT
                            FROM   TBL_EXP_STORE_INFO A
                                   JOIN TBL_EXP_STORE_FINANCIAL B
                                     ON  1 = 1
                                     AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                     AND A.STORE_ID   = B.STORE_ID
                                     AND B.AMOUNT     IS NOT NULL
                                     AND B.YEAR       = #{year}
                                     AND B.MONTH      = #{month} 

                            AND    SUBJECT = 'SUBJECT_001'
                            WHERE  1 = 1
                            AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                            <if test=" !'ALL'.equals(region) ">
                                AND    A.REGION =  #{region} 
                            </if>
                            <if test=" !'ALL'.equals(store) ">
                                AND    STORE_ID = #{store} 
                            </if>
                            <if test=" !'ALL'.equals(supervisor) ">
                                AND    A.SUPERVISOR = #{supervisor} 
                            </if>
                        ) B
                        ON  1 = 1
                        AND A.SP_CSTM_ID = B.SP_CSTM_ID   
                        AND A.STORE_ID   = B.STORE_ID   
                        AND A.YEAR       = B.YEAR     
                        AND A.MONTH      = B.MONTH 
               ) A
        WHERE 1 = 1
        ORDER BY A.ACHIEVE_RATIO DESC 
    </select>        
    
    <select id="getTbRotationRatioRank" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getTbRotationRatioRank */
                SELECT A.SP_CSTM_ID
                      ,A.STORE_ID
                      ,A.STORE_NM3 
                      ,A.TB_ROTATION
                      ,A.TB_ROTATION_GOAL
                      ,B.YEAR
                      ,B.MONTH
                      ,ROUND((A.TB_ROTATION_GOAL/ROUND(SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT),2)) * 100,2)  AS TB_ROTATION_RATIO
                FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                       JOIN TBL_EXP_STORE_SALES B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{year}
                         AND B.MONTH      = #{month} 
                       JOIN (
                                SELECT SP_CSTM_ID
                                      ,STORE_ID
                                      ,YEAR
                                      ,MONTH
                                      ,COUNT(1) DAY_CNT
                                FROM   TBL_EXP_STORE_SALES
                                WHERE  1 = 1
                                AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                AND    YEAR       = #{year}
                                AND    MONTH      = #{month} 
                                AND    RECEIPT_CNT IS NOT NULL
                                AND    RECEIPT_CNT != 0
                                GROUP BY SP_CSTM_ID
                                        ,STORE_ID
                                        ,YEAR
                                        ,MONTH
                            ) C
                         ON  1 = 1
                         AND B.SP_CSTM_ID = C.SP_CSTM_ID
                         AND B.STORE_ID   = C.STORE_ID
                         AND B.YEAR       = C.YEAR
                         AND B.MONTH      = C.MONTH
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                AND    A.TB_ROTATION IS NOT NULL
                <if test=" !'ALL'.equals(region) ">
                    AND    A.REGION =  #{region} 
                </if>
                <if test=" !'ALL'.equals(store) ">
                    AND    STORE_ID = #{store} 
                </if>
                <if test=" !'ALL'.equals(supervisor) ">
                    AND    A.SUPERVISOR = #{supervisor} 
                </if>
                GROUP BY A.SP_CSTM_ID
                        ,A.STORE_ID
                        ,A.STORE_NM3
                        ,A.TB_ROTATION
                        ,A.TB_ROTATION_GOAL
                        ,B.YEAR
                        ,B.MONTH
                ORDER BY ROUND((A.TB_ROTATION_GOAL/ROUND(SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT),2)) * 100,2) DESC
    </select> 
    
    <select id="getPreMonthAchieveRatio" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getPreMonthAchieveRatio */
        SELECT  SP_CSTM_ID
               ,PRE_MONTH_ACHIEVE_RATIO
        FROM   (
                    SELECT A.SP_CSTM_ID
                          ,CASE WHEN SUM(A.PRE_AMOUNT) !=  0 THEN ROUND( (SUM(A.AMOUNT)/SUM(A.PRE_AMOUNT)) * 100 ,2)
                                ELSE 0
                           END AS PRE_MONTH_ACHIEVE_RATIO
                    FROM   (
                                /* 당월 */
                                SELECT B.SP_CSTM_ID
                                      ,B.STORE_ID
                                      ,A.STORE_NM3
                                      ,B.AMOUNT AS AMOUNT
                                      ,0        AS PRE_AMOUNT
                                FROM   TBL_EXP_STORE_INFO A
                                       JOIN TBL_EXP_STORE_FINANCIAL B
                                         ON  1 = 1
                                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                         AND A.STORE_ID   = B.STORE_ID
                                         AND B.AMOUNT     IS NOT NULL
                                         AND B.YEAR       = #{year}
                                         AND B.MONTH      = #{month} 
                                         AND B.SUBJECT = 'SUBJECT_001'
                                WHERE  1 = 1
                                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                                <if test=" !'ALL'.equals(region) ">
                                    AND    A.REGION =  #{region} 
                                </if>
                                <if test=" !'ALL'.equals(store) ">
                                    AND    A.STORE_ID = #{store} 
                                </if>
                                <if test=" !'ALL'.equals(supervisor) ">
                                    AND    A.SUPERVISOR = #{supervisor} 
                                </if> 
                                UNION ALL
                                /* 전월 */
                                SELECT B.SP_CSTM_ID
                                      ,B.STORE_ID
                                      ,A.STORE_NM3
                                      ,0        AS AMOUNT
                                      ,B.AMOUNT AS PRE_AMOUNT
                                FROM   TBL_EXP_STORE_INFO A
                                       JOIN TBL_EXP_STORE_FINANCIAL B
                                         ON  1 = 1
                                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                         AND A.STORE_ID   = B.STORE_ID
                                         AND B.AMOUNT     IS NOT NULL
                                         AND B.YEAR       = #{prevYear}
                                         AND B.MONTH      = #{prevMonth}
                                         AND B.SUBJECT = 'SUBJECT_001'
                                WHERE  1 = 1
                                
                                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                                <if test=" !'ALL'.equals(region) ">
                                    AND    A.REGION =  #{region} 
                                </if>
                                <if test=" !'ALL'.equals(store) ">
                                    AND    A.STORE_ID = #{store} 
                                </if>
                                <if test=" !'ALL'.equals(supervisor) ">
                                    AND    A.SUPERVISOR = #{supervisor} 
                                </if> 
                                ) A
                    GROUP BY  A.SP_CSTM_ID
               ) A
    </select> 

    
    <select id="getPreMonthAchieveRatioRank" resultType="java.util.HashMap" flushCache="true"  useCache="false">
        /*  dashboardCorPerformance.getPreMonthAchieveRatioRank */
        SELECT A.STORE_ID
              ,A.STORE_NM3
              ,A.YEAR       
              ,A.MONTH
              ,A.PRE_MONTH_ACHIEV_RATIO
        FROM   (
                SELECT A.STORE_ID
                      ,A.STORE_NM3
                      ,A.YEAR       
                      ,A.MONTH
                      ,SUM(A.AMOUNT)     AS AMOUNT
                      ,SUM(A.PRE_AMOUNT) AS PRE_AMOUNT
                      ,CASE WHEN SUM(A.PRE_AMOUNT) !=  0 THEN ROUND( (SUM(A.AMOUNT)/SUM(A.PRE_AMOUNT)) * 100 ,2)
                            ELSE 0
                       END AS PRE_MONTH_ACHIEV_RATIO
                FROM   (
                /* 당월 */
                SELECT A.STORE_ID
                      ,A.STORE_NM3
                      ,B.YEAR       
                      ,B.MONTH
                      ,SUM(B.AMOUNT) AS AMOUNT
                      ,0             AS PRE_AMOUNT
                FROM   TBL_EXP_STORE_INFO A
                       JOIN TBL_EXP_STORE_FINANCIAL B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{year} 
                         AND B.MONTH      = #{month}  
                AND    SUBJECT = 'SUBJECT_001'
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
               <if test=" !'ALL'.equals(region) ">
                   AND    A.REGION =  #{region} 
               </if>
               <if test=" !'ALL'.equals(store) ">
                   AND    A.STORE_ID = #{store} 
               </if>
               <if test=" !'ALL'.equals(supervisor) ">
                   AND    A.SUPERVISOR = #{supervisor} 
               </if>
                GROUP BY A.STORE_ID
                        ,A.STORE_NM3
                        ,B.YEAR
                        ,B.MONTH
                UNION ALL 
                /* 전월 */
                SELECT A.STORE_ID
                      ,A.STORE_NM3
                      ,B.YEAR     
                      ,#{month}      AS MONTH
                      ,0             AS AMOUNT
                      ,SUM(B.AMOUNT) AS PRE_AMOUNT
                FROM   TBL_EXP_STORE_INFO A
                       JOIN TBL_EXP_STORE_FINANCIAL B
                         ON  1 = 1
                         AND A.SP_CSTM_ID = B.SP_CSTM_ID
                         AND A.STORE_ID   = B.STORE_ID
                         AND B.YEAR       = #{prevYear}
                         AND B.MONTH      = #{prevMonth}
                AND    SUBJECT = 'SUBJECT_001'
                WHERE  1 = 1
                AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                <if test=" !'ALL'.equals(region) ">
                    AND    A.REGION =  #{region} 
                </if>
                <if test=" !'ALL'.equals(store) ">
                    AND    A.STORE_ID = #{store} 
                </if>
                <if test=" !'ALL'.equals(supervisor) ">
                    AND    A.SUPERVISOR = #{supervisor} 
                </if>
                GROUP BY A.STORE_ID
                        ,A.STORE_NM3
                        ,B.YEAR
                        ,B.MONTH
                ) A
                GROUP BY A.STORE_ID
                        ,A.STORE_NM3
                        ,A.YEAR
                        ,A.MONTH      
        ) A
        ORDER BY A.PRE_MONTH_ACHIEV_RATIO DESC
    </select> 
    
    <select id="getPreMonthTbRotationRatioRank" resultType="java.util.HashMap" flushCache="true"  useCache="false">
    /* dashboardCorPerformance.getPreMonthTbRotationRatioRank */
    SELECT SP_CSTM_ID
          ,STORE_ID
          ,STORE_NM3
          ,TB_ROTATION_RATIO
    FROM   (
        SELECT SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM3
              ,CASE WHEN SUM(PRE_RECEIPT_CNT) !=  0 THEN  ROUND(SUM(RECEIPT_CNT)/SUM(PRE_RECEIPT_CNT) *100,2)
                    ELSE 0
               END AS TB_ROTATION_RATIO
        FROM  (
                        /* 당월 */
                        SELECT A.SP_CSTM_ID
                              ,B.YEAR
                              ,B.MONTH
                              ,A.STORE_ID
                              ,A.STORE_NM3 
                              ,CASE WHEN MAX(C.DAY_CNT) !=  0 THEN ROUND((SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT) )  ,2)
                                    ELSE 0
                               END      AS RECEIPT_CNT
                              ,0        AS PRE_RECEIPT_CNT
                        FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                               JOIN TBL_EXP_STORE_SALES B
                                 ON  1 = 1
                                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                 AND A.STORE_ID   = B.STORE_ID
                                 AND B.YEAR       = #{year} 
                                 AND B.MONTH      = #{month} 
                               JOIN (
                                        SELECT SP_CSTM_ID
                                              ,STORE_ID
                                              ,YEAR
                                              ,MONTH
                                              ,COUNT(1) DAY_CNT
                                        FROM   TBL_EXP_STORE_SALES
                                        WHERE  1 = 1
                                        AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                        AND    YEAR       = #{year} 
                                        AND    MONTH      = #{month} 
                                        AND    RECEIPT_CNT IS NOT NULL
                                        AND    RECEIPT_CNT != 0
                                        GROUP BY SP_CSTM_ID
                                                ,STORE_ID
                                                ,YEAR
                                                ,MONTH
                                    ) C
                                 ON  1 = 1
                                 AND B.SP_CSTM_ID = C.SP_CSTM_ID
                                 AND B.STORE_ID   = C.STORE_ID
                                 AND B.YEAR       = C.YEAR
                                 AND B.MONTH      = C.MONTH
                        WHERE  1 = 1
                        AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                        <if test=" !'ALL'.equals(region) ">
                            AND    A.REGION =  #{region} 
                        </if>
                        <if test=" !'ALL'.equals(store) ">
                            AND    STORE_ID = #{store} 
                        </if>
                        <if test=" !'ALL'.equals(supervisor) ">
                            AND    A.SUPERVISOR = #{supervisor} 
                        </if>
                        GROUP BY A.SP_CSTM_ID
                                ,B.YEAR
                                ,B.MONTH
                                ,A.STORE_ID
                                ,A.STORE_NM3
                        UNION ALL
                        /* 전월 */
                        SELECT A.SP_CSTM_ID
                              ,B.YEAR
                              ,B.MONTH
                              ,A.STORE_ID
                              ,A.STORE_NM3 
                              ,0        AS RECEIPT_CNT 
                              ,CASE WHEN MAX(C.DAY_CNT) !=  0 THEN ROUND((SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT) )  ,2)
                                    ELSE 0
                               END       AS PRE_RECEIPT_CNT
                        FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                               JOIN TBL_EXP_STORE_SALES B
                                 ON  1 = 1
                                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                 AND A.STORE_ID   = B.STORE_ID
                                 AND B.YEAR       = #{prevYear}
                                 AND B.MONTH      = #{prevMonth}
                               JOIN (
                                        SELECT SP_CSTM_ID
                                              ,STORE_ID
                                              ,YEAR
                                              ,MONTH
                                              ,COUNT(1) DAY_CNT
                                        FROM   TBL_EXP_STORE_SALES
                                        WHERE  1 = 1
                                        AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                        AND    YEAR       = #{prevYear}
                                        AND    MONTH      = #{prevMonth}
                                        AND    RECEIPT_CNT IS NOT NULL
                                        AND    RECEIPT_CNT != 0
                                        GROUP BY SP_CSTM_ID
                                                ,STORE_ID
                                                ,YEAR
                                                ,MONTH
                                    ) C
                                 ON  1 = 1
                                 AND B.SP_CSTM_ID = C.SP_CSTM_ID
                                 AND B.STORE_ID   = C.STORE_ID
                                 AND B.YEAR       = C.YEAR
                                 AND B.MONTH      = C.MONTH
                        WHERE  1 = 1
                        AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                        <if test=" !'ALL'.equals(region) ">
                            AND    A.REGION =  #{region} 
                        </if>
                        <if test=" !'ALL'.equals(store) ">
                            AND    STORE_ID = #{store} 
                        </if>
                        <if test=" !'ALL'.equals(supervisor) ">
                            AND    A.SUPERVISOR = #{supervisor} 
                        </if>
                        GROUP BY A.SP_CSTM_ID
                                ,B.YEAR
                                ,B.MONTH
                                ,A.STORE_ID
                                ,A.STORE_NM3
        )
         GROUP BY SP_CSTM_ID
              ,STORE_ID
              ,STORE_NM3
    )
    ORDER BY TB_ROTATION_RATIO DESC
    </select> 

    <select id="getPreMonthTbRotationRatio" resultType="java.util.HashMap" flushCache="true"  useCache="false">
    /* dashboardCorPerformance.getPreMonthTbRotationRatio */
    SELECT SP_CSTM_ID
          ,TB_ROTATION_RATIO
    FROM   (
        SELECT SP_CSTM_ID
              ,CASE WHEN SUM(PRE_RECEIPT_CNT) !=  0 THEN  ROUND(SUM(RECEIPT_CNT)/SUM(PRE_RECEIPT_CNT) *100,2)
                    ELSE 0
               END AS TB_ROTATION_RATIO
        FROM  (
                        /* 당월 */
                        SELECT A.SP_CSTM_ID
                              ,B.YEAR
                              ,B.MONTH
                              ,A.STORE_ID
                              ,A.STORE_NM3 
                              ,CASE WHEN MAX(C.DAY_CNT) !=  0 THEN ROUND((SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT) )  ,2)
                                    ELSE 0
                               END      AS RECEIPT_CNT
                              ,0        AS PRE_RECEIPT_CNT
                        FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                               JOIN TBL_EXP_STORE_SALES B
                                 ON  1 = 1
                                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                 AND A.STORE_ID   = B.STORE_ID
                                 AND B.YEAR       = #{year} 
                                 AND B.MONTH      = #{month} 
                               JOIN (
                                        SELECT SP_CSTM_ID
                                              ,STORE_ID
                                              ,YEAR
                                              ,MONTH
                                              ,COUNT(1) DAY_CNT
                                        FROM   TBL_EXP_STORE_SALES
                                        WHERE  1 = 1
                                        AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                        AND    YEAR       = #{year} 
                                        AND    MONTH      = #{month} 
                                        AND    RECEIPT_CNT IS NOT NULL
                                        AND    RECEIPT_CNT != 0
                                        GROUP BY SP_CSTM_ID
                                                ,STORE_ID
                                                ,YEAR
                                                ,MONTH
                                    ) C
                                 ON  1 = 1
                                 AND B.SP_CSTM_ID = C.SP_CSTM_ID
                                 AND B.STORE_ID   = C.STORE_ID
                                 AND B.YEAR       = C.YEAR
                                 AND B.MONTH      = C.MONTH
                        WHERE  1 = 1
                        AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                        <if test=" !'ALL'.equals(region) ">
                            AND    A.REGION =  #{region} 
                        </if>
                        <if test=" !'ALL'.equals(store) ">
                            AND    STORE_ID = #{store} 
                        </if>
                        <if test=" !'ALL'.equals(supervisor) ">
                            AND    A.SUPERVISOR = #{supervisor} 
                        </if>
                        GROUP BY A.SP_CSTM_ID
                                ,B.YEAR
                                ,B.MONTH
                                ,A.STORE_ID
                                ,A.STORE_NM3
                        UNION ALL
                        /* 전월 */
                        SELECT A.SP_CSTM_ID
                              ,B.YEAR
                              ,B.MONTH
                              ,A.STORE_ID
                              ,A.STORE_NM3 
                              ,0        AS RECEIPT_CNT 
                              ,CASE WHEN MAX(C.DAY_CNT) !=  0 THEN ROUND((SUM(B.RECEIPT_CNT) / MAX(C.DAY_CNT) )  ,2)
                                    ELSE 0
                               END       AS PRE_RECEIPT_CNT
                        FROM   TBL_EXP_STORE_INFO  A/* 매장정보 */
                               JOIN TBL_EXP_STORE_SALES B
                                 ON  1 = 1
                                 AND A.SP_CSTM_ID = B.SP_CSTM_ID
                                 AND A.STORE_ID   = B.STORE_ID
                                 AND B.YEAR       = #{prevYear}
                                 AND B.MONTH      = #{prevMonth}
                               JOIN (
                                        SELECT SP_CSTM_ID
                                              ,STORE_ID
                                              ,YEAR
                                              ,MONTH
                                              ,COUNT(1) DAY_CNT
                                        FROM   TBL_EXP_STORE_SALES
                                        WHERE  1 = 1
                                        AND    SP_CSTM_ID = #{sessionVo.spCstmId}
                                        AND    YEAR       = #{prevYear}
                                        AND    MONTH      = #{prevMonth}
                                        AND    RECEIPT_CNT IS NOT NULL
                                        AND    RECEIPT_CNT != 0
                                        GROUP BY SP_CSTM_ID
                                                ,STORE_ID
                                                ,YEAR
                                                ,MONTH
                                    ) C
                                 ON  1 = 1
                                 AND B.SP_CSTM_ID = C.SP_CSTM_ID
                                 AND B.STORE_ID   = C.STORE_ID
                                 AND B.YEAR       = C.YEAR
                                 AND B.MONTH      = C.MONTH
                        WHERE  1 = 1
                        AND    A.SP_CSTM_ID = #{sessionVo.spCstmId}
                        <if test=" !'ALL'.equals(region) ">
                            AND    A.REGION =  #{region} 
                        </if>
                        <if test=" !'ALL'.equals(store) ">
                            AND    STORE_ID = #{store} 
                        </if>
                        <if test=" !'ALL'.equals(supervisor) ">
                            AND    A.SUPERVISOR = #{supervisor} 
                        </if>
                        GROUP BY A.SP_CSTM_ID
                                ,B.YEAR
                                ,B.MONTH
                                ,A.STORE_ID
                                ,A.STORE_NM3
        )
         GROUP BY SP_CSTM_ID
    )
    </select>
    
</mapper>
