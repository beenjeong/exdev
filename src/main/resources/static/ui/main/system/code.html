<meta charset="utf-8">
<script type="text/javascript">
var <@pageId> = {
		 checkedItems : { GRP: [], CD: [] }
		 ,selectedGrpCd : {GRP_CODE_ID:'', GRP_CODE_NM:''}
		 ,excelParamGrp : {}
		 ,excelParamCd : {}
		 ,pageInit : () =>{
			 
				<@pageId>.showChildInsertBtn(false);
			 
		 }
		,searchList : (mode = 'ALL',obj) => {

			let requestParm = {};
			
			if( obj ){
				requestParm["GRP_CODE_ID"] 	= obj.GRP_CODE_ID;
				if(obj.CODE_ID)
					requestParm["CODE_ID"] 	= obj.CODE_ID;
			}
			
			const grpCodeQuery 	= {queryId 		: "system.getGrpCodeList"	,requestParm	: requestParm}
			const codeQuery 	= {queryId 		: "system.getCodeList"		,requestParm	: requestParm}
			const queryGroupAll = {queryGroup : [grpCodeQuery , codeQuery]};
			const queryGroupGRP = {queryGroup : [grpCodeQuery 			 ]};
			const queryGroupCD  = {queryGroup : [			   codeQuery ]};
			
			<@pageId>.excelParamGrp= grpCodeQuery;
			<@pageId>.excelParamCd = codeQuery;
			
			var parm = mode == "ALL" ? queryGroupAll : mode=="GRP" ?  queryGroupGRP : mode=="CD" ?  queryGroupCD : queryGroupAll;
			
			C_COM.requestQuery(parm, function(resultData) {

					let insertBtnShow = false;
					
					if( resultData.state == "S"){

						var rparm = {};
						if( mode == "ALL" || mode == "GRP" ){
							
							rparm = {
									 targetId 		: "grpCodeList"
									,list			: resultData.data["system.getGrpCodeList"]
							} 
							C_COM.renderHtml("<@pageId>", rparm);
							
						}
						if( mode == "ALL" || mode == "CD" ){
							
							rparm = {
									 targetId 		: "codeList"
									,list			: resultData.data["system.getCodeList"]
							} 
							C_COM.renderHtml("<@pageId>", rparm);
							if( mode == "CD" ){insertBtnShow = true;}
						}
						
						<@pageId>.setHandler();
						
						$("[name='<@pageId>_ckAll']").prop("checked", false);
						
					}else{
						alert(resultData.msg)
					}

					<@pageId>.showChildInsertBtn(insertBtnShow);
			});
			
		}		
		,updateItem : (sectionId, param) => {

			const requestParm = param ? param : {} ;
			
			if( !requestParm["GRP_CODE_ID"] || requestParm["GRP_CODE_ID"] 	== '')requestParm["GRP_CODE_ID"] 	= C_COM.makeUniqueId();
			if( !requestParm["CODE_ID"] 	|| requestParm["CODE_ID"] 		== '')requestParm["CODE_ID"] 		= C_COM.makeUniqueId();
			
			var parm = {
					 queryId 		: <@pageId>.isGrpCodeSection(sectionId) ? "system.updateGrpCode" :"updateCode"
					,requestParm	: requestParm
			}

			C_COM.requestQuery(parm, function(resultData) {
				
				if( resultData.state == 'S'){

					if( <@pageId>.isGrpCodeSection(sectionId) )<@pageId>.searchList();
					else <@pageId>.searchList("CD",{GRP_CODE_ID: <@pageId>.selectedGrpCd["GRP_CODE_ID"]});
					
					console.log("Item 저장 성공");
				}				
			});
		}  
		,deleteItem : (sectionId, delKey) => {
			
			const requestParm = <@pageId>.isGrpCodeSection(sectionId) ? { "GRP_CODE_ID":delKey.GRP_CODE_ID}
															: { "GRP_CODE_ID":delKey.GRP_CODE_ID, "CODE_ID": delKey.CODE_ID}
			
			var parm = {
					 queryId 		: <@pageId>.isGrpCodeSection(sectionId) ? "system.deleteGrpCode" : "system.deleteCode"
					,requestParm	: requestParm 
			}
			C_COM.requestQuery(parm, function(resultData) {
				if( resultData.state == 'S'){
					
					if( <@pageId>.isGrpCodeSection(sectionId) )<@pageId>.searchList();
					else <@pageId>.searchList("CD",{GRP_CODE_ID: <@pageId>.selectedGrpCd["GRP_CODE_ID"]});
					
					console.log("Item 삭제 성공")
				}				
			});				
		}
		, deleteOne : (sectionId, key) =>{

			const delObj = {}
			delObj["GRP_CODE_ID"] = key.split("||")[0];
			delObj["CODE_ID"	] = key.split("||")[1];
   			<@pageId>.deleteItem(sectionId,delObj)
   		
		}		
		,openPopup : (sectionId, $tds) => {

			let param = [];	 
			$.each( $tds , function(){
				console.log(""+this)
				const key = $(this).attr("id");
				const val = $(this).attr("value");
				param.push( { "key": key, "val": val } );
				
			})

			C_POP.open('popup_codeUpdatePopup'
					, {	  sectionId:sectionId.replace("<@pageId>_", "")
						, selectedGrpCd: <@pageId>.selectedGrpCd
						, param:param
						, "nextSortOrder":<@pageId>.getNextSortOrder(sectionId)
					}
			, function(retData) {
				
				if(isValid(retData)){
					<@pageId>.updateItem(sectionId, retData);
				}
			});
			
		}
		,setHandler : () => {
			 
		    $("[name='<@pageId>_insert']").click(function(){

		    	const sectionId = $(this).closest("section").attr("id");
		    	if( <@pageId>.isGrpCodeSection(sectionId) )<@pageId>.selectedGrpCd= {GRP_CODE_ID:'', GRP_CODE_NM:''};
				<@pageId>.openPopup(sectionId);

		    })
		    
		    $("[name='<@pageId>_delete']").click(function(){
		    	
		    	const sectionId = $(this).closest("section").attr("id");
		    	const checkedItems = <@pageId>.isGrpCodeSection(sectionId) ? <@pageId>.checkedItems["GRP"] : <@pageId>.checkedItems["CD"]
		    	checkedItems.forEach( key =>{
		    		let newKey = key;
		    		if( <@pageId>.isGrpCodeSection(sectionId) ){
		    			newKey = key.GRP_CODE_ID+ "||" + key.CODE_ID;
		    		}
					<@pageId>.deleteOne(sectionId,newKey);
		    	})
		    	
		    })
		    
		    $("[id^='<@pageId>_delete_']").click(function(){

		    	const sectionId = $(this).closest("section").attr("id");
		    	const key = $(this).attr("key");
		    	if( <@pageId>.isGrpCodeSection(sectionId) ){
		    		const tbl_exp_code_CNT = +$(this).parent().siblings("#TBL_EXP_CODE_CNT").attr("value");
		    		if( tbl_exp_code_CNT > 0){
		    			alert("TBL_EXP_CODE 데이터를 먼저 삭제하신 후 GRP CODE를 삭제할 수 있습니다.");
			    		return;
		    		}
		    	}
				<@pageId>.deleteOne(sectionId,key);
				
		    })
		    
		    $("[id^='<@pageId>_modify_']").click(function(){

		    	const sectionId = $(this).closest("section").attr("id");
		    	const index = $(this).attr("index");
				const $tds = $("#"+sectionId+" [name='<@pageId>_tr_"+index+"'] td");
				<@pageId>.openPopup(sectionId,$tds);
				
		    })
		    
		    $("[name='<@pageId>_excelDownload']").click(function(){
		    	
		    	const sectionId = $(this).closest("section").attr("id");
		    	if( <@pageId>.isGrpCodeSection(sectionId) ){
		    		
					<@pageId>.excelDownload(sectionId,"TB_EXP_GRPCODE");
					
		    	}else{
		    		
		    		<@pageId>.excelDownload(sectionId,"TB_EXP_CODE");
		    	}
		    })
		    
		    $("[name^='<@pageId>_tr']").click(function(e){

		        if( $(e.target).attr("id").indexOf("<@pageId>_ck_") < 0){

			    	const sectionId = $(this).closest("section").attr("id");
			    	if( <@pageId>.isGrpCodeSection(sectionId) ){

			    		<@pageId>.selectedGrpCd["GRP_CODE_ID"] = $(this).attr("value");
			    		<@pageId>.selectedGrpCd["GRP_CODE_NM"] = $(this).children("#GRP_CODE_NM").attr("value");
			    		<@pageId>.searchList('CD' , <@pageId>.selectedGrpCd);
						<@pageId>.showChildInsertBtn(true);
			    	}
			    	
		        }
		    })
		    
		    $("#<@pageId>_search").click( () =>{
		    	<@pageId>.searchList();
		    })
		    
		    <@pageId>.chkHandler();

		}
		,chkHandler : () => {
			
		    $("[name='<@pageId>_ckAll']").click(function() {
			   	
		    	const sectionId = $(this).closest("section").attr("id");
		    	const gubun =  <@pageId>.isGrpCodeSection(sectionId) ? "grp" : "cd"  ;
		    	
		    	const isAllChk =  $(this).prop("checked");
		    	const selector =  "[id^='<@pageId>_ck_"+gubun+"_']"

				$(selector).prop("checked", isAllChk);
		    	const ckboxes = $(selector);
		    	if( gubun == "grp"){
		    		
			    	<@pageId>.checkedItems["GRP"] = isAllChk ? ckboxes.map(function() { return this.value; }).get() : [];
		    	}else{
		    		
		    		<@pageId>.checkedItems["CD" ] = isAllChk ? ckboxes.map(function() { 
																		    			const GRP_CODE_ID 	= this.value.split("||")[0];
																		    			const CODE_ID 		= this.value.split("||")[1];
																		    			const OBJ			= {GRP_CODE_ID:GRP_CODE_ID, CODE_ID: CODE_ID}
																		    			return OBJ;}).get() : []
		    	}
			    
		    });
		    
		    $("[id^='<@pageId>_ck_grp_']").click(function(){
		    	
		    	const sectionId = $(this).closest("section").attr("id");
		    	
		    	const GRP_CODE_ID = $(this).attr("value");
		    	
		    	if( $(this).is(":checked") ){
		    		
			    	<@pageId>.checkedItems["GRP"].push( GRP_CODE_ID );
		    	}else{
		    		
		            const index = <@pageId>.checkedItems["GRP"].indexOf(GRP_CODE_ID);
		            if (index !== -1) {
		                <@pageId>.checkedItems["GRP"].splice(index, 1);
		            }
		    	}
		    	
		        const $checkboxSelector = $("#"+sectionId+" [id^='<@pageId>_ck_']")
		        const allCheckboxChecked = $checkboxSelector.length === $checkboxSelector.filter(":checked").length;
		        $("#"+sectionId+" [name='<@pageId>_ckAll']").prop("checked", allCheckboxChecked);
		        
		    })
		    
		    $("[id^='<@pageId>_ck_cd_']").click(function(){
		    	
		    	const sectionId = $(this).closest("section").attr("id");
		    	
		    	const GRP_CODE_ID 	= $(this).attr("value").split("||")[0];
		    	const CODE_ID 		= $(this).attr("value").split("||")[1];
		    	
		    	if( $(this).is(":checked") ){
		    		
			    	<@pageId>.checkedItems["CD"].push( {GRP_CODE_ID:GRP_CODE_ID,CODE_ID:CODE_ID} ); 
		    	}else{
		    		
					const index = <@pageId>.checkedItems["CD"].findIndex(item => item.GRP_CODE_ID === GRP_CODE_ID && item.CODE_ID === CODE_ID);
		            if (index !== -1) {
		                <@pageId>.checkedItems["CD"].splice(index, 1);
		            }
		    	}
		    	
		        const $checkboxSelector = $("#"+sectionId+" [id^='<@pageId>_ck_']")
		        const allCheckboxChecked = $checkboxSelector.length === $checkboxSelector.filter(":checked").length;
		        $("#"+sectionId+" [name='<@pageId>_ckAll']").prop("checked", allCheckboxChecked);

		    })
		
		}
		,getNextSortOrder : (sectionId) =>{

			if( <@pageId>.isGrpCodeSection(sectionId) )	return $("#"+sectionId+" [name='<@pageId>_tr_0'] #NEXT_SORT_ORDER").attr("value");
			else return $("#"+sectionId+" [name='<@pageId>_tr_0'] #NEXT_SORT_ORDER").attr("value");
			
		}
		,isGrpCodeSection : (sectionId) =>{
			
			return sectionId.indexOf("grp") > -1 ? true : false;
		}
		,showChildInsertBtn : (show) =>{
			
			const $btn = $("#<@pageId>_code_section [name='<@pageId>_insert']");
			show ?	$btn.show() : $btn.hide();
			
		} 		
  		,excelDownload : (sectionId,title) => {
			
  			let excelParam = {};
  			
  			if( <@pageId>.isGrpCodeSection(sectionId) ){
  				
  				excelParam = <@pageId>.excelParamGrp
  				
  			}else{
  				
  				excelParam = <@pageId>.excelParamCd
  				
  			}
		
			const $tds = $("#"+sectionId + " [name='<@pageId>_tr_0'] td");
			excelParam["columnOrders"] 		= <@pageId>.excelColumnOrder($tds, this);
 			excelParam["downInfo"		] 	= JSON.stringify({  title : title, menu : "CODE 관리"});
 			excelParam["requestParm"	] 	= JSON.stringify( excelParam.requestParm );
 			

 			var xhr = new XMLHttpRequest();
    	    var urlParams = new URLSearchParams( excelParam ).toString();
    	    xhr.open('GET', '/excelDownload.do?'+urlParams, true);
    	    xhr.responseType = 'blob';

    	    xhr.onload = function() {
    	    	
    	        if (xhr.status === 200) {

    	            var blob = new Blob([xhr.response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    	            var url = window.URL.createObjectURL(blob);
    	            
    	            var a = document.createElement('a');
    	            a.href = url;
    	            a.download = title+'.xlsx';
    	            
    	            document.body.appendChild(a);
    	            a.click();
    	            window.URL.revokeObjectURL(url);
    	            
    	        } else {
    	        	
    	            console.error('Failed to download excel file');
    	            
    	        }
    	    };
    	    
    	    xhr.send();
		},
		excelColumnOrder : ($tds) =>{
  				let columnOrders = [];
  				
  				$.each( $tds, function(){

  					columnOrders.push( $(this).attr("id") );
  				})
  				
  				return columnOrders;
		}
  		
}
// Page Load가 완료된후 실행 된다.
C_PM.onLoadPage("<@pageId>", function() {
	
	<@pageId>.pageInit();
	<@pageId>.searchList();

});
// History back으로 이동해왔을 경우 이루틴이 실행된다.
C_HM.onReturn("<@pageId>", function(pageId, data) {

});
</script> 
<div class="cont_wrap">

	<div class="cont_top">
		<h2><i class="icon_bullet"></i>TBL_EXP_GRPCODE</h2>
	</div>
	<section class="sec_wrap" id="<@pageId>_grpcode_section" >
		<!-- search area -->
		<div class="search_area mt0">
			<!-- 멀티 선택 -->
			<div class="fl">
				<button type="button" class="btn fl" name="<@pageId>_delete"><i class="icon_trash"></i>삭제</button>
				<button type="button" class="btn select fl" id="<@pageId>_search">조회</button>
				<div style="width:200px;" id="<@pageId>_grp_multiSelect"></div>

				<div class="search_inputWrap">
					<input type="search" name=""><button class="search_btn"><i class="icon_search"></i></button>
				</div>
			</div>

			<div class="search_right">
				<button type="button" class="btn select fl" name="<@pageId>_insert"><i class="icon_user_plus"></i>추가</button>
				<button type="button" class="btn fl"  name="<@pageId>_excelDownload"><i class="icon_download"></i> Excel 다운로드</button>
            </div>
		</div>
		<!-- 테이블 -->
		<div class="tbl01 col tbl_scroll">
			<table>
				<caption>TBL_EXP_GRPCODE</caption>
				<colgroup>
					<col style="width:40px;"/>
					<col style="width:100px;"/>
					<col style="width:80px;"/>
					<col style="width:110px;"/>
					<col style="width:80px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:80px;"/>
				</colgroup>
				<thead>
					<tr>
						<th scope="col"><input type="checkbox" name="<@pageId>_ckAll"></th>
						<th scope="col">GRP_CODE_ID</th>
						<th scope="col">GRP_CODE_NM</th>
						<th scope="col">CODE_DESC</th>
						<th scope="col">USE_YN</th>
						<th scope="col">DEL_YN</th>
						<th scope="col">SORT_ORDER</th>
						<th scope="col">UPDATE_USER</th>
						<th scope="col">UPDATE_DATE</th>
						<th scope="col">TBL_EXP_CODE</th>
						<th scope="col"></th>
					</tr>
				</thead>
				<tbody  id="grpCodeList">
				</tbody>
<script type="text/x-jsrender" id="grpCodeList_template">	
				{{for list}}
				<tr name="<@pageId>_tr_{{:#index}}" 							 value='{{:GRP_CODE_ID}}'>
					<td><input type='checkbox' id="<@pageId>_ck_grp_{{:#index}}" value='{{:GRP_CODE_ID}}'></td>
 					<td id='GRP_CODE_ID'		value='{{:GRP_CODE_ID}}'		>{{:GRP_CODE_ID}}</td>
 					<td id='GRP_CODE_NM'		value='{{:GRP_CODE_NM}}'		>{{:GRP_CODE_NM}}</td>
 					<td id='CODE_DESC'			value='{{:CODE_DESC}}' 			>{{:CODE_DESC}}</td>
 					<td id='USE_YN'				value='{{:USE_YN}}' 			>{{:USE_YN}}</td>
 					<td id='DEL_YN'				value='{{:DEL_YN}}' 			>{{:DEL_YN}}</td>
 					<td id='SORT_ORDER'			value='{{:SORT_ORDER}}'			>{{:SORT_ORDER}}</td>
 					<td id='UPDATE_USER' 		value='{{:UPDATE_USER}}'		>{{:UPDATE_USER}}</td>
 					<td id='UPDATE_DATE'		value='{{:UPDATE_DATE}}' 		>{{:UPDATE_DATE}}</td>
 					<td id='TBL_EXP_CODE_CNT'	value='{{:TBL_EXP_CODE_CNT}}'	>{{:TBL_EXP_CODE_CNT}}</td>
 					<td id='NEXT_SORT_ORDER'	value='{{:NEXT_SORT_ORDER}}'	>
						<button type="button" class="btn fl" id="<@pageId>_modify_{{:#index}}" index="{{:#index}}"><i class="icon_download"></i></button>
						<button type="button" class="btn fl" id="<@pageId>_delete_{{:#index}}" key='{{:GRP_CODE_ID}}'><i class="icon_trash"></i></button>
					</td>
				</tr>
				{{/for}}
</script>
<script type="text/x-jsrender" id="grpCodeList_noData_template">	
				<tr>	
					<td colspan=11>자료가 없습니다.</td>	
				</tr>
</script>
			</table>
		</div>
		<!-- paging -->
		<div class="paging">
			<a href="#none" class="btn_pg_first disabled">첫번째 페이지</a>
			<a href="#none" class="btn_pg_prev disabled">이전 페이지</a>
			<strong title="현재 페이지">1</strong>
			<a href="#none">2</a>
			<a href="#none">3</a>
			<a href="#none">4</a>
			<a href="#none">5</a>
			<a href="#none" class="btn_pg_next">다음 페이지</a>
			<a href="#none" class="btn_pg_last">마지막 페이지</a>
		</div>
	</section>
<!--  -->			
	<div class="cont_top">
		<h2><i class="icon_bullet"></i>TBL_EXP_CODE</h2>
	</div>
	<section class="sec_wrap" id="<@pageId>_code_section">
		<!-- search area -->
		<div class="search_area mt0">
			<!-- 멀티 선택 -->
			<div class="fl">
				<button type="button" class="btn fl" name="<@pageId>_delete"><i class="icon_trash"></i>삭제</button>

				<div style="width:200px;" id="<@pageId>_cd_multiSelect"></div>

				<div class="search_inputWrap">
					<input type="search" name=""><button class="search_btn"><i class="icon_search"></i></button>
				</div>
			</div>

			<div class="search_right">
				<button type="button" class="btn select fl" name="<@pageId>_insert"><i class="icon_user_plus"></i>추가</button>
				<button type="button" class="btn fl"  name="<@pageId>_excelDownload"><i class="icon_download"></i> Excel 다운로드</button>
            </div>
		</div>
		<!-- 테이블 -->
		<div class="tbl01 col tbl_scroll">
			<table>
				<caption>TBL_EXP_CODE</caption>
				<colgroup>
					<col style="width:40px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:80px;"/>
					<col style="width:110px;"/>
					<col style="width:80px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/>
					<col style="width:100px;"/> 
					<col style="width:100px;"/>
					<col style="width:80px;"/>
				</colgroup>
				<thead>
					<tr>
						<th scope="col"><input type="checkbox" name="<@pageId>_ckAll"></th>
						<th scope="col">GRP_CODE_ID</th>
						<th scope="col">GRP_CODE_NM</th>
						<th scope="col">CODE_ID</th>
						<th scope="col">CODE_NM</th>
						<th scope="col">CODE_DESC</th>
						<th scope="col">USE_YN</th>
						<th scope="col">DEL_YN</th>
						<th scope="col">SORT_ORDER</th>
						<th scope="col">UPDATE_USER</th>
						<th scope="col">UPDATE_DATE</th> 
						<th scope="col"></th>
					</tr>
				</thead>
				<tbody  id="codeList">
				</tbody>
<script type="text/x-jsrender" id="codeList_template">	
				{{for list}}
				<tr name="<@pageId>_tr_{{:#index}}">
					<td><input type='checkbox' id="<@pageId>_ck_cd_{{:#index}}" value='{{:GRP_CODE_ID}}||{{:CODE_ID}}'></td>
 					<td id='GRP_CODE_ID'	value='{{:GRP_CODE_ID}}'	>{{:GRP_CODE_ID}}</td>
 					<td id='GRP_CODE_NM'	value='{{:GRP_CODE_NM}}'	>{{:GRP_CODE_NM}}</td>
 					<td id='CODE_ID'		value='{{:CODE_ID}}'		>{{:CODE_ID}}</td>
 					<td id='CODE_NM'		value='{{:CODE_NM}}' 		>{{:CODE_NM}}</td>
 					<td id='CODE_DESC'		value='{{:CODE_DESC}}' 		>{{:CODE_DESC}}</td>
 					<td id='USE_YN'			value='{{:USE_YN}}' 		>{{:USE_YN}}</td>
 					<td id='DEL_YN'			value='{{:DEL_YN}}' 		>{{:DEL_YN}}</td>
 					<td id='SORT_ORDER'		value='{{:SORT_ORDER}}'		>{{:SORT_ORDER}}</td>
 					<td id='UPDATE_USER' 	value='{{:UPDATE_USER}}'	>{{:UPDATE_USER}}</td>
 					<td id='UPDATE_DATE'	value='{{:UPDATE_DATE}}' 	>{{:UPDATE_DATE}}</td>
 					<td id='NEXT_SORT_ORDER'value='{{:NEXT_SORT_ORDER}}'>
						<button type="button" class="btn fl" id="<@pageId>_modify_{{:#index}}" index="{{:#index}}"><i class="icon_download"></i></button>
						<button type="button" class="btn fl" id="<@pageId>_delete_{{:#index}}" key='{{:GRP_CODE_ID}}||{{:CODE_ID}}'><i class="icon_trash"></i></button>
					</td>
				</tr>
				{{/for}}
</script>
<script type="text/x-jsrender" id="codeList_noData_template">	
				<tr>	
					<td colspan=12>자료가 없습니다.</td>	
				</tr>
</script>
			</table>
		</div>
		<!-- paging -->
		<div class="paging">
			<a href="#none" class="btn_pg_first disabled">첫번째 페이지</a>
			<a href="#none" class="btn_pg_prev disabled">이전 페이지</a>
			<strong title="현재 페이지">1</strong>
			<a href="#none">2</a>
			<a href="#none">3</a>
			<a href="#none">4</a>
			<a href="#none">5</a>
			<a href="#none" class="btn_pg_next">다음 페이지</a>
			<a href="#none" class="btn_pg_last">마지막 페이지</a>
		</div>
	</section>			
			
</div>