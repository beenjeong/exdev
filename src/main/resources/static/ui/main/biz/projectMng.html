<meta charset="utf-8">
<script type="text/javascript">
	var <@pageId> = {
		 projectList 	: []
		,projectMap 	: {}
		,openProjectPopup : function() {
			C_POP.open('popup_operation_projectRegistPopup', {}, function(retData) {
				if(retData.reload == 'Y') {
					<@pageId>.loadData();
				}
			});
		 }
		,loadData : function() {
			var parm = {
				 queryId 		: "contract.getProjectList"
				,requestParm	: {}
			}
			C_COM.requestQuery(parm, function(resultData) {
				
				let projectList = resultData.data;
				
				<@pageId>.projectList = resultData.data;
				
				<@pageId>.projectMap = arrayToMap(<@pageId>.projectList, "CONTRACT_ID");
				
				
				$.each(projectList, function(idx) {
					projectList[idx].SHOW_BTN = "Y";
					if			(this.PROCESS_STATE == "PRE_CONTRACT") {
						projectList[idx].APPR_BTN_TITLE = "담당자 지정 결재";
					}
					/*
					else if	(this.PROCESS_STATE == "CONTRACTING") {
						projectList[idx].APPR_BTN_TITLE = "계약 체결 결재";
					}
					*/
					else {
						projectList[idx].SHOW_BTN = "N";
					}
				});
				
				
				
				$.each(<@pageId>.projectList, function(idx) {
					if(isEmpty(this.APP_STATE_NM)) <@pageId>.projectList[idx].APP_STATE_NM = "";
				});
				
				var rparm = {
						 targetId 		: "<@pageId>_projectList"
						,list			: projectList
						,targetTotalId	: "<@pageId>_totalCnt"
				}
				C_COM.renderHtml("<@pageId>", rparm);
			});  
		 }
		,modify	: function(index) {
			let projectItem = <@pageId>.projectList[index];
			
			C_POP.open('popup_operation_projectRegistPopup', {mode : 'M', projectItem : projectItem }, function(retData) {
				if(retData.reload == 'Y') {
					<@pageId>.loadData();
				}
			});
		 }
		,approval : function(idx) {

			let CONTRACT_ID 	= <@pageId>.projectList[idx].CONTRACT_ID;
			let PROCESS_STATE	= <@pageId>.projectList[idx].PROCESS_STATE;
			
			<@pageId>.saveWorkHistory(CONTRACT_ID);
			return;
			
			
	        let requestParm = {};
	        
	        let apprProcessState = "";
	        
	        if(PROCESS_STATE == "PRE_CONTRACT") {
		        requestParm = {
		        	 RELATION_ID 	: CONTRACT_ID
		        	,AFTER_SERVICE	: `ApprovalAfterService.updateProjectProcess`
		        	,AFTER_PARM		: `{"PROCESS_STATE" : "CONTRACTING"}`				// 결재 완료 후 처리에서 Update상태값 (체결 대기)
		        	,TITLE			: `담당 컨설턴트 지정 결재 요청`
		        };
		        apprProcessState = "ON_CONTRACTING_APPR";
	        }
/*
	        else if(PROCESS_STATE == "CONTRACTING") {
		        requestParm = {
		        	 RELATION_ID 	: CONTRACT_ID
		        	,AFTER_SERVICE	: `ApprovalAfterService.updateProjectProcess`
		        	,AFTER_PARM		: `{"PROCESS_STATE" : "CONTRACTED"}`				// 결재 완료 후 처리에서 Update상태값 (계약 체결)
		        	,TITLE			: `계약 체결 결재 요청`
		        }
		        apprProcessState = "ON_CONTRACTED_APPR";
	        }
*/	        
	        C_POP.open('popup_appr_apprReqPopup', requestParm, function(retData) {
				if(retData.state == "S") {
					// 프로젝트 Update
					var parm = {
						 queryId 		: "contract.updateProject"
						,requestParm	: {
							 CONTRACT_ID 	: CONTRACT_ID
				        	,PROCESS_STATE	: apprProcessState
						}
					}
					C_COM.requestQuery(parm, function(resultData) {
						if(resultData.state == "S") {
								
							// work history 저장
							<@pageId>.saveWorkHistory(CONTRACT_ID);
							
							<@pageId>.loadData();
							
						} else {
							C_POP.alert('결재상신 상태값 갱신 중 문제가 발생 했습니다.');
						}
					});  
				}
	        });
		 }
		,saveWorkHistory : function(CONTRACT_ID) {
			let projectInfo = <@pageId>.projectMap[CONTRACT_ID];
			
			let content = `<<${projectInfo.BUYER_NM}>> 고객 담당 컨설턴트 <<지정 결재 요청>>`;
			
			C_COM.saveWorkHistory(projectInfo.USER_ID, content);
		 }
	}
	// Page Load가 완료된후 실행 된다.
	C_PM.onLoadPage("<@pageId>", function() {
		<@pageId>.loadData();
	});
	// History back으로 이동해왔을 경우 이루틴이 실행된다.
	C_HM.onReturn("<@pageId>", function(pageId, data) {

	});
</script>
		<div class="cont_wrap backWhite">
			<div class="cont_top">
				<h2><i class="icon_bullet"></i>프로젝트 관리</h2>
			</div>
			<section class="sec_wrap list" style="height:calc(100% - 43px);">
				<!-- search area -->
				<div class="search_area mt0">
					<div class="fl">
						<button class="btn select fl" onclick="<@pageId>.openProjectPopup()">프로젝트 추가</button>
		            </div>
		            <div class="search_right">
						<strong class="total">Total: <span class="pointColr" id="<@pageId>_totalCnt">0</span></strong>
		            </div>
				</div>
				<!-- 테이블 -->
				<div class="tbl01 col tbl_scroll" style="max-height:506px;">
					<div class="tbl01 col tbl_head">
						<table>
							<caption>프로젝트 리스트</caption>
							<colgroup>
								<col style="width:40px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
								<col style="width:*"/>
								<col style="width:150px;"/>
								<col style="width:200px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
							</colgroup>
							<thead>
								<tr>
									<th scope="col">No.</th>
									<th scope="col">고객명</th>
									<th scope="col">영업담당자명</th>
									<th scope="col">실행담당자명</th>
									<th scope="col">상품명</th>
									<th scope="col">상태</th>
									<th scope="col">등록/수정일</th>
									<th scope="col">결재</th>
									<th scope="col"><i class="icon_pen"></i> &nbsp;&nbsp; <i class="icon_trash"></i></th>
								</tr>
							</thead>
						</table>
					</div>
					<div class="tbl01 col tbl_body_scroll">
						<table>
							<caption>프로젝트 리스트 Body</caption>
							<colgroup>
								<col style="width:40px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
								<col style="width:*"/>
								<col style="width:150px;"/>
								<col style="width:200px;"/>
								<col style="width:150px;"/>
								<col style="width:150px;"/>
							</colgroup>
							<tbody id="<@pageId>_projectList">
							</tbody>
							<script type="text/x-jsrender" id="<@pageId>_projectList_template">						
								{{for list}}
								<tr>
									<td>{{:#index + 1}}</td>
									<td>{{:BUYER_NM}}</td>
									<td>{{:USER_NM}}</td>
									<td>{{:CONSULTANT_USER_NM}}</td>
									<td>{{:CONSULTING_NM}}</td>
									<td>{{:PROCESS_STATE_NM}}</td>
									<td>{{:UPDATE_DATE}}{{:#index}}</td>
									<td>
									{{if SHOW_BTN=="Y" ~index=#index}} 
										<button type="button" class="btn fc tc" onclick="<@pageId>.approval({{:~index}})">{{:APPR_BTN_TITLE}}</button>
									{{else}}
										{{:APP_STATE_NM}}	
									{{/if}}
									</td>
									<td>
										<button onclick="<@pageId>.modify({{:#index}})"><i class="icon_pen"		></i></button>	&nbsp; 
										<button onclick="<@pageId>.delete({{:#index}})"><i class="icon_trash"	></i></button>
									</td>
								</tr>
								{{/for}}
							</script>
							<script type="text/x-jsrender" id="<@pageId>_projectList_noData_template">	
								<tr>	
									<td colspan=9>자료가 없습니다.</td>	
								</tr>
							</script>
						</table>
					</div>
				</div>
			</section>
		</div>
