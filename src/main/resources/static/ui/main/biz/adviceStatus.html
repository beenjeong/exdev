<meta charset="utf-8">
<script type="text/javascript">
	var <@pageId> = {
		 projectList	: []
		,cardListMap	: {}
		,pageInit		: function() {
			// 첫번째 SelectBox 세팅	    
			let parm = {
				 queryId 		: "advice.getMyCustomerList"
				,requestParm	: {}
			}
			C_COM.requestQuery(parm, function(resultData) {
				let codeList = C_COM.makeArrayTwoColumn(resultData.data, "BUYER_ID", "BUYER_NM");
				var singleboxList = { 
					 defaultItem 	: ["", "고객선택"]
					,data 			: codeList
				 	,targetId 		: "<@pageId>_customerSelectBox" 
				}
				C_UICOM.makeSelectBox(singleboxList, "single");
			});
			
			// 두번째 SelectBox 세팅	    
			let parm2 = {
				 queryId 		: "advice.getConsultingList"
				,requestParm	: {}
			}
			C_COM.requestQuery(parm2, function(resultData) {
				let codeList = C_COM.makeArrayTwoColumn(resultData.data, "CONSULTING_ID", "CONSULTING_NM");
				var singleboxList = { 
					 defaultItem 	: ["", "상품선택"]
					,data 			: codeList
				 	,targetId 		: "<@pageId>_consultingSelectBox" 
				}
				C_UICOM.makeSelectBox(singleboxList, "single");
			});
			
			// 결재 현황 리스트
			let parm3 = {
				 queryId 		: "contract.getAdviceApprovalProcessList"
				,requestParm	: {}
			}
			C_COM.requestQuery(parm3, function(resultData) {
				var parm = {
					 targetId 		: "approvalProcessList"
					,list			: resultData.data
					,targetTotalId	: "<@pageId>_totalCnt"
				}
				C_COM.renderHtml("<@pageId>", parm);
			});
		}
		,loadCardList 	: function() {
			
			var parm = {
				 queryId 		: "contract.getProjectList"
				,requestParm	: {}
			}
			C_COM.requestQuery(parm, function(resultData) {
				<@pageId>.projectList = resultData.data;
				
				let cardListMap = {}
				 
				$.each(<@pageId>.projectList, function(){
					if(isEmpty(cardListMap[this.PROCESS_STATE])) cardListMap[this.PROCESS_STATE] = [];
					cardListMap[this.PROCESS_STATE].push(this);
				});

				<@pageId>.cardListMap = cardListMap;
				
				<@pageId>.renderCardList();
				
			});  
		 }
		,renderCardList : function() {

			<@pageId>.setCard("cardList0", ["PRE_CONTRACT", "ON_CONTRACTING_APPR", "ON_CONTRACTED_APPR"], "제안 진행 중"	);

			<@pageId>.setCard("cardList1", ["CONTRACTING", "CONTRACTED", "ON_COMPLETED_APPR"]			, "체결완료 및 실행");
			
			<@pageId>.setCard("cardList2", ["COMPLETED"]												, "실행 완료"		);
			
			$("#<@pageId> .upDownToggle").unbind("click");
		    $("#<@pageId> .upDownToggle").bind("click", function(){
		        $(this).children().toggleClass('down');
		        $(this).parent().parent().next().toggleClass('upDown');
		    });
		 }
		,setCard : function(targetId, contractState, cardTitle) {
			
			let list = [];
			
			$.each(contractState, function() {
				let newlist = <@pageId>.cardListMap[this]
				if(isEmpty(newlist)) return true;
				list = $.merge(list, newlist);
			});
			
			var parm = {
				 targetId 		: targetId
				,templateId		: "basecard"
				,list			: list
				,cardTitle		: cardTitle
				,cardCnt		: list.length
			}
			C_COM.renderHtml("<@pageId>", parm);
			
			$.each(list, function(idx) {
				let key_cslist = `${parm.targetId}_cslist${idx}`;
				C_COMP.import(key_cslist, "component_biz_compConsultingContent"	, {contractInfo : this}, function(data) {
					//dalert(data);
				});
				let key_sch = `${parm.targetId}_sch${idx}`;
				C_COMP.import(key_sch, "component_biz_compScheduleList"			, {contractInfo : this}, function(data) {
					//dalert(data);
				});
				let key_todo = `${parm.targetId}_todo${idx}`;
				C_COMP.import(key_todo, "component_biz_compTodoList"			, {contractInfo : this}, function(data) {
					//dalert(data);
				});
				let key_wk = `${parm.targetId}_wk${idx}`;
				C_COMP.import(key_wk, "component_biz_compConsultingProcess"		, {contractInfo : this}, function(data) {
					//dalert(data);
				});
			});
		 }
	}
	// Page Load가 완료된후 실행 된다.
	C_PM.onLoadPage("<@pageId>", function() {
		
		<@pageId>.pageInit();

		<@pageId>.loadCardList();
		
	});
	// History back으로 이동해왔을 경우 이루틴이 실행된다.
	C_HM.onReturn("<@pageId>", function(pageId, data) {
		
	});
</script>
<div class="cont_wrap backWhite">
	<div class="cont_top">
		<h2><i class="icon_bullet"></i>자문 진행 현황</h2>
	</div>
	<!-- search area -->
	<ul class="info_wrap search m05" style="width:calc(100% - 10px);">
		<li>
			<label>조회기간</label>
			<div class="info">
				<div class="calendar_wrap fl">
					<input type="text" id="from" name="from" class="datepicker" style="width:114px">
					<label for="to">~</label>
					<input type="text" id="to" name="to" class="datepicker" style="width:114px">
				</div>
				<div id="<@pageId>_customerSelectBox" 	class="select_box fl" style="width:160px"></div>
                <div id="<@pageId>_consultingSelectBox" class="select_box fl" style="width:200px"></div>
                <span class="tit01 fl lh33 tr" style="min-width:40px;">내용</span>
                <input type="text" name="" class="fl">
                <button class="btn select fl">검색</button>
			</div>
		</li>
	</ul>
	<div class="cont_top mt20 mb0 pr10 clearFix">
		<h3 class="fl font16">결재 승인 대기</h3>
		<div class="fr">결재 진행 중 <strong class="pointColr" id="<@pageId>_totalCnt">2</strong> 건</div>
	</div>
	<div class="sec_scroll" style="height:calc(100% - 140px);">
		<section class="sec_wrap">
			<div class="cont_box project_list">
				<ol id="approvalProcessList">
				</ol>
			</div>
			<script type="text/x-jsrender" id="approvalProcessList_template">						
				{{for list}}
					<li><a href="javascript:;">{{:#index+ 1}}. {{:BUYER_NM}} / {{:CONSULTING_NM}} / {{:PROCESS_STATE_NM}}</a></li>
				{{/for}}
			</script>
			<script type="text/x-jsrender" id="approvalProcessList_noData_template">						
				{{for list}}
					<li>검색된 Data가 없습니다.</li>
				{{/for}}
			</script>
			
		</section>
		<section class="sec_wrap">
			<div class="cont_box col3 project_list" id="cardList0">
			</div>
			<div class="cont_box col3 project_list" id="cardList1">
			</div>
			<div class="cont_box col3 project_list" id="cardList2">
			</div>
		</section>
	</div>
	<script type="text/x-jsrender" id="basecard_template">						
		<h3 class="tc">{{:cardTitle}} <strong class="pointColr">{{:cardCnt}}</strong> 건</div></h3>
		{{for list 	~targetId=targetId}}
		<div class="cont_top mt15 clearFix">
			<h4 class="fl">{{:BUYER_NM}} / {{:CONSULTING_NM}}</h4>
			<div class="fr inlineBlock_wrap">
				<button class="btn small upDownToggle"><i class="up"></i></button>
			</div>
		</div>
		<div class="cont_box">
			<!-- 컨설팅 진행 목록 -->
			<div id="{{:~targetId}}_cslist{{:#index}}">
			</div>
			<!-- Schedule -->
			<div id="{{:~targetId}}_sch{{:#index}}">
			</div>
			<!-- TO-DO List -->
			<div id="{{:~targetId}}_todo{{:#index}}">					
			</div>
			<!-- 메모하기 -->
			<div id="{{:~targetId}}_wk{{:#index}}">
			</div>
		</div>
		{{/for}}
	</script>
	<script type="text/x-jsrender" id="basecard_noData_template">	
		<h3 class="tc">{{:cardTitle}} <strong class="pointColr">{{:cardCnt}}</strong> 건</div></h3>
		<div class="cont_top mt15 clearFix">
		</div>
		<div class="cont_box">
			<div class="tc">등록된 카드가 없습니다.</div>
		</div>
	</script>
	
</div>
