<meta charset="utf-8">
<script type="text/javascript">
var <@pageId> = {
		
		menuList : []	
		,selectedCheck : []
		,adminMenu : () => {

				var parm = {
					 queryId 		: "admin.getMenuList"
					,requestParm	: {}
				}
				C_COM.requestQuery(parm, function(resultData) {

					<@pageId>.menuList = resultData.data;
					
					var rparm = {
							 targetId 		: "menuList"
							,list			: resultData.data
						}
				
					C_COM.renderHtml("<@pageId>", rparm);
					
  					$("#<@pageId>_updateItems input").each( (idx, obj) => {
						$(obj).val("");
					});  
  					
  					$("#PARENT_MENU_ID option").remove();
  					const parentOption = resultData.data.filter( option => option.MENU_DEPTH == 0);
  					$("#PARENT_MENU_ID").append("<option value=''>Select Parent Menu</option>");
  					parentOption.forEach(menu => {
  						$("#PARENT_MENU_ID").append("<option value='" + menu.MENU_ID + "'>" + menu.MENU_DESC + "</option>");
  					});
					
					<@pageId>.setHandler();
				});
								
		}
		,updateMenu : (menuId) => {
				
				const requestParm = {};
				const updateItems = $("#<@pageId>_updateItems input,#<@pageId>_updateItems select");
				
				const valuesArray = updateItems.map(function() {
					if( this.name == "MENU_ID" && this.value =="" )this.value = menuId;
				    return { name: this.name, value: ""+$(this).val() };
				}).get();
				valuesArray.forEach(function(item) {
					requestParm[item.name] = item.value;
				});
				
				var parm = {
						 queryId 		: "admin.updateMenu"
						,requestParm	: requestParm
				}
				C_COM.requestQuery(parm, function(resultData) {
					if( resultData.state == 'S'){
						<@pageId>.adminMenu();
						alert("메뉴 저장 성공");
					}				
				});
		}  
		,deleteMenu : (item) => {

				var parm = {
						 queryId 		: "admin.deleteMenu"
						,requestParm	: {"MENU_ID":item}
				}
				C_COM.requestQuery(parm, function(resultData) {
					if( resultData.state == 'S'){
						<@pageId>.adminMenu();
						alert("메뉴 삭제 성공")
					}				
				});				
		}  
		,setHandler : () => {
				
   				$("[id^='<@pageId>.ck_']").on('change', function () {

					const checkedCheckboxes = $("[id^='<@pageId>.ck_']:checked");
					if( checkedCheckboxes && checkedCheckboxes.length>0){
				        <@pageId>.selectedCheck = [];
				        checkedCheckboxes.each(function() {
				            <@pageId>.selectedCheck.push($(this).val());
				        });
					}
				})   
				
		        $("#menuList").on('click', 'tr', function () {
		            const rowId = $(this)[0].id;
		            if (rowId) {
		            	const tds = $("#menuList>#"+rowId+" td");
		            	if( tds ){
		            		$(tds).each( (idx,td) => {
		            			const name = td.getAttribute("id");
		            			const value = td.getAttribute("value");
		            			$("#<@pageId>_updateItems input").each((idx,obj)=>{
		            				if(obj.name == name){
		            					obj.value = value;
		            				}
		            			})
		            		})
		            	}
		            }
		        });		
   				
   			    $("select[name='PARENT_MENU_ID']").on('change', function() {
					debugger;
   			        const selectedValue = $(this).val();
   			        console.log("Selected PARENT_MENU_ID value: " + selectedValue);
   			        
   			     	<@pageId>.menuList.forEach( menu => {
   			     		if( menu.MENU_ID == selectedValue){
   			     			debugger;
   			     			$("#<@pageId>_updateItems input[name='PARENT_MENU_ID']").val(menu.MENU_ID);
   			     			const menuDept = Number(menu.MENU_DEPTH) + 1;
   			     			$("#<@pageId>_updateItems input[name='MENU_DEPTH']").val(menuDept);
   			     			
   			     			
   			     		}
   			     	})
   			    });   				
   				
		}

}

// Page Load가 완료된후 실행 된다.
C_PM.onLoadPage("<@pageId>", function(parm) {

		<@pageId>.adminMenu();
			
		//추가/저장 버튼		
		$('#<@pageId>_insertMenu,#<@pageId>_saveMenu').on('click', function (e) {
		
			const id = "dontWork" ;//crypto.randomUUID(); 
			<@pageId>.updateMenu(id);
		})
		
		//삭제 버튼		
		$('#<@pageId>_deleteMenu').on('click', function (e) {
		
			<@pageId>.selectedCheck.forEach( item =>
				<@pageId>.deleteMenu(item)
			)
		}) 
		
});
	
// History back으로 이동해왔을 경우 이루틴이 실행된다.
C_HM.onReturn("<@pageId>", function(pageId, data) {

});
</script>
<style>
    .side {
        display: flex;
        align-items: center;
        margin-bottom: 10px; 
    }

    .button {
        margin-left: 10px; 
    }
</style>

<div>
     <div class='side' id='<@pageId>_updateItems'>
					<input type='hidden' name='MENU_ID' > 
		MENU NM : 	<input type='text' name='MENU_NM' > 
		MENU_DEPTH:	<input type='text' name='MENU_DEPTH' readonly style='background-color:rgb(200, 200, 200)'> 
		MENU DESC : <input type='text' name='MENU_DESC' > 
		PAGE ID : 	<input type='text' name='PAGE_ID' >
		PARENT MENU :<select id="PARENT_MENU_ID" name="PARENT_MENU_ID"/>

	     <button id='<@pageId>_insertMenu'>추가</button>
	     <button id='<@pageId>_deleteMenu'>삭제</button>
	     <button id='<@pageId>_saveMenu'>저장</button>
     </div>
           <table>
             <thead>
                 <tr>
                     <th>ck</th>
                     <th>#번호</th>
                     <th>MENU_ID</th>
                     <th>MENU_NM</th>
                     <th>PARENT_MENU_ID</th>
                     <th>MENU_DEPTH</th>
                     <th>MENU_DESC</th>
                     <th>PAGE_ID</th>
                     <th>UPDATE_USER</th>
                     <th>UPDATE_DATE</th>
                 </tr>
             </thead>
             <tbody id="menuList">
             </tbody>
<script type="text/x-jsrender" id="menuList_template">	
				{{for list}}
				<tr id="menuId_{{:#index}}">
 					<td><input type='checkbox' id="<@pageId>.ck_{{:#index}}" value='{{:MENU_ID}}'></td>
 					<td id='index' value='{{:#index}}'>#{{:#index}}</td>
 					<td id='MENU_ID' value='{{:MENU_ID}}' style='width:100px'>{{:MENU_ID}}</td>
 					<td id='MENU_NM' value='{{:MENU_NM}}'>{{:MENU_NM}}</td>
 					<td id='PARENT_MENU_ID' value='{{:PARENT_MENU_ID}}'>{{:PARENT_MENU_ID}}</td>
 					<td id='MENU_DEPTH' value='{{:MENU_DEPTH}}'>{{:MENU_DEPTH}}</td>
 					<td id='MENU_DESC' value='{{:MENU_DESC}}'>{{:MENU_DESC}}</td>
 					<td id='PAGE_ID' value='{{:PAGE_ID}}'>{{:PAGE_ID}}</td>
 					<td id='UPDATE_USER' value='{{:UPDATE_USER}}'>{{:UPDATE_USER}}</td>
 					<td id='UPDATE_DATE' value='{{:UPDATE_DATE}}'>{{:UPDATE_DATE}}</td>
				</tr>
				{{/for}}
</script>
<script type="text/x-jsrender" id="menuList_noData_template">	
				<tr>	
					<td colspan=7>자료가 없습니다.</td>	
				</tr>
</script>
           </table>
    </div>
</div>