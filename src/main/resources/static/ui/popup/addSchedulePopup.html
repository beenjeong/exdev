<meta charset="utf-8">
<script type="text/javascript">
    var <@popupId> = {
         userArr : []
        ,scheduleId : ''
        ,userIndex : 0
        ,mode : ''
        ,close : function() {
            console.log("=== close ===");
            var obj = new Object();
            C_POP.close(obj);
         }
	    ,searchSchedule : function(scheduleId) {
	    	console.log("== searchSchedule 2=>"+scheduleId);
	    	
	    	let requestParm = {};
            requestParm["scheduleId"]  = scheduleId;
            let parm = {
                 queryId        : "schedule.getScheduleList"
                ,requestParm    : requestParm
            }
            C_COM.requestQuery(parm, function(resultData) {
            	
                <@popupId>.setSchedule(resultData.data[0]);
            });
            
            /* 결재자 조회*/
            /*
            let parmDtl = {
                 queryId        : "approval.getApprovalUser"
                ,requestParm    : requestParm
            }
            C_COM.requestQuery(parmDtl, function(resultData) {

                let rparmDtl = {
                         targetId   : "tableId"
                        ,list       : resultData.data
                    }
                C_COM.renderHtml("<@popupId>", rparmDtl);
                
            });
            */
	     }
	    ,setSchedule : function( data ) {
	    	console.log("== requestQuery SCHEDULE_ID=>"+data.SCHEDULE_ID);
            console.log("== requestQuery TITLE=>"+data.TITLE);
            console.log("== requestQuery WORK_TYPE=>"+data.WORK_TYPE);
            
            $('#<@popupId>_title').val(data.TITLE);
            $('#<@popupId>_position').val(data.POSITION);
            $('#<@popupId>_description').val(data.DESCRIPTION);
            
            /////////////////////////////////////////////////////////////////////////////////////////////
            
            // 셀렉트 박스 세팅
            C_UICOM.setSingleBox("selectBoxWorkType", data.WORK_TYPE);
            C_UICOM.setSingleBox("selectBoxLoopType", data.LOOP_TYPE);
            C_UICOM.setSingleBox("scheduleSecretYn", data.WORK_TYPE);
            C_UICOM.setSingleBox("selectBoxStartTime", data.START_TIME_HOUR);
            C_UICOM.setSingleBox("selectBoxStartMinute", data.START_TIME_MINUTE);
            C_UICOM.setSingleBox("selectBoxEndTime", data.END_TIME_HOUR);
            C_UICOM.setSingleBox("selectBoxEndMinute", data.END_TIME_MINUTE);
            
            // 참석자
            var peopleArr = new Array();
            var obj = new Object();
            
            obj.index = "user_id";
            obj.spCstmId = "spCstmId";
            obj.user_id = "user_id";
            obj.user_nm = "user_nm";
            obj.user_desc = "user_desc";
            obj.e_mail = "e_mail";
            
            console.log("obj.spCstmId =>"+obj.spCstmId);
            console.log("obj.user_id =>"+obj.user_id);
            console.log("obj.user_nm =>"+obj.user_nm);
            console.log("obj.user_desc =>"+obj.user_desc);
            console.log("obj.e_mail =>"+obj.e_mail);
            
            peopleArr.push(obj);
            
            console.log(peopleArr);
            
            //<@popupId>.addMember(retData);
	    }
	    
	    ,memberSearchPopup : function() {
	
	        C_POP.open('popup_userSearchPopup', {}, function(retData) {
	            <@popupId>.addMember(retData);
	        });
	     }
        ,addMember : function(retData) {
            
            for (let obj of retData) {
                
                <@popupId>.userArr.push(obj.user_id);
                
                let user = obj.user_nm+"/"+obj.user_desc+"/"+obj.user_id+"/"+obj.e_mail;
                
                let htmlData = '';
                htmlData += '<li id="approvalUser'+ <@popupId>.userIndex +'" >';
                htmlData += '<input type="hidden" id="userId'+ <@popupId>.userIndex +'"   name="userId"   value="'+ obj.user_id +'">';
                htmlData += '<input type="hidden" id="apprType'+ <@popupId>.userIndex +'" name="apprType" value="APPR">';
                htmlData += '    <span class="txt">' + user + '</span>';
                htmlData += '    <button class="pay_close" onclick="<@popupId>.deleteUser(' + <@popupId>.userIndex + ');">삭제</button>';
                htmlData += '</li>';
                
                $('#<@popupId> .<@popupId>approver_list').append(htmlData);
                <@popupId>.userIndex++;
            }
         }
        ,deleteUser : function(num) {/* 결재자 삭제 */
            $("#<@popupId> #approvalUser" + num).remove();
            <@popupId>.userArr[num].is_delete = true;
         }
        
        ,delete : function() {
        	
        	console.log("deleteSchedule");
        	
        	let requestParm = {};            
            requestParm["scheduleId"]  = <@popupId>.scheduleId;
            
            // 데이타 삭제
            var parm = {
                 serviceId              : "ScheduleService.deleteSchedule"
                ,requestParm            : requestParm
            }
            C_COM.requestService(parm, function(resultData) {
                
                console.log("resultData.data.state =>"+resultData.data.state);
                if("S" == resultData.data.state){
                	dalert("일정이 삭제에 성공하였습니다.");
                }else{
                    dalert("일정이 삭제에 실패하였습니다.");
                }
                
            });
            
        }
        ,update : function() {
            
            console.log("update");

            let title = $('#<@popupId>_title').val();
            let date  = $('#<@popupId>_date').val();
            
            if (title.length < 1) {
                alert("제목을 입력해 주세요.");
                $("#<@popupId>_title").focus();
                return false;
            }
            
            if (date.length < 1) {
                alert("일정을 입력해 주세요.");
                $("#<@popupId>_date").focus();
                return false;
            }
            
            let requestParm = {};            
            requestParm["scheduleId"]  = <@popupId>.scheduleId;
            requestParm["title"]  = title;
            requestParm["date"]  = date;
            requestParm["position"]  = $('#<@popupId>_position').val();
            requestParm["description"]  = $('#<@popupId>_description').val();
            requestParm["loopType"]  = <@popupId>.loopType;
            requestParm["workType"]  = <@popupId>.workType;
            requestParm["startTimeH"]  = <@popupId>.startTimeH;
            requestParm["startTimeM"]  = <@popupId>.startTimeM;
            requestParm["endTimeH"]  = <@popupId>.endTimeH;
            requestParm["endTimeM"]  = <@popupId>.endTimeM;
            requestParm["secretYn"]  = <@popupId>.secretYn;
            
            console.log(" == scheduleId ==>"+requestParm["scheduleId"]);
            console.log(" == title ==>"+requestParm["title"]);
            console.log(" == date ==>"+requestParm["date"]);
            console.log(" == position ==>"+requestParm["position"]);
            console.log(" == description ==>"+requestParm["description"]);
            console.log(" == loopType ==>"+requestParm["loopType"]);
            console.log(" == workType ==>"+requestParm["workType"]);
            console.log(" == startTimeH ==>"+requestParm["startTimeH"]);
            console.log(" == startTimeM ==>"+requestParm["startTimeM"]);
            console.log(" == endTimeH ==>"+requestParm["endTimeH"]);
            console.log(" == endTimeM ==>"+requestParm["endTimeM"]);
            console.log(" == secretYn ==>"+requestParm["secretYn"]);
            
            /////////////////////////////////////////////////////////////////////
            var scheduleIdArry = new Array();
            
            for(i=0; i< 30; i++){
                scheduleIdArry.push(C_COM.makeUniqueId());
            }

            requestParm["scheduleIdArry"]  = scheduleIdArry;
            /////////////////////////////////////////////////////////////////////
            
            var userArry = new Array();
            
            for(i=0; i< <@popupId>.userIndex; i++){
                var userId = $('#userId'+i).val();

                if(typeof userId != "undefined" && userId != null && userId != ""){
                    var item = new Object();
                    item.user_id  = userId;
                    userArry.push(item);
                }
            }
            requestParm["users"]  = JSON.stringify(userArry);
                    
            // 데이타 저장
            var parm = {
                 serviceId              : "ScheduleService.updateSchedule"
                ,requestParm            : requestParm
            }
            C_COM.requestService(parm, function(resultData) {
                
                console.log("resultData.data.state =>"+resultData.data.state);
                if("S" == resultData.data.state){

                    var obj = new Object();
                    obj.title = title;
                    obj.start = date+"T"+startTimeH+":"+startTimeM+":"+"00";
                    obj.end   = date+"T"+endTimeH+":"+endTimeM+":"+"00";
                    obj.textColor = "#fff";
                    
                    if( workType == 'SEMINAR'){//세미나
                        obj.color = "#d770c0";  
                    }else if( workType == 'SEND_EMAIL'){//이메일 전송
                        obj.color = "#72bfd2"; 
                    } else if( workType == 'OTHER_WORK'){//그 외 업무
                        obj.color = "#8dcc76"; 
                    } else if( workType == 'TEL_CONSUL'){//전화상담
                        obj.color = "#e5b266"; 
                    } else if( workType == 'MEETING'){//미팅
                        obj.color = "#EE7C7C"; 
                    } else if( workType == 'SCHEDULE'){//회사 내부 일정
                        obj.color = "#7E7CEE"; 
                    } else{} 
                    C_POP.close(obj);
                }else{
                    dalert("일정이 추가에 실패하였습니다.");
                }
                
            });
            
        }
        ,save : function( ) {
        	
        	let title = $('#<@popupId>_title').val();
        	let date  = $('#<@popupId>_date').val();
        	
            if (title.length < 1) {
                alert("제목을 입력해 주세요.");
                $("#<@popupId>_title").focus();
                return false;
            }
            
            if (date.length < 1) {
                alert("일정을 입력해 주세요.");
                $("#<@popupId>_date").focus();
                return false;
            }
            
            let requestParm = {};            
            requestParm["scheduleId"]  = <@popupId>.scheduleId;
            requestParm["title"]  = title;
            requestParm["date"]  = date;
            requestParm["position"]  = $('#<@popupId>_position').val();
            requestParm["description"]  = $('#<@popupId>_description').val();
            requestParm["loopType"]  = <@popupId>.loopType;
            requestParm["workType"]  = <@popupId>.workType;
            requestParm["startTimeH"]  = <@popupId>.startTimeH;
            requestParm["startTimeM"]  = <@popupId>.startTimeM;
            requestParm["endTimeH"]  = <@popupId>.endTimeH;
            requestParm["endTimeM"]  = <@popupId>.endTimeM;
            requestParm["secretYn"]  = <@popupId>.secretYn;
            requestParm["userId"]  = "trigger11kr";
            
            /////////////////////////////////////////////////////////////////////
            var scheduleIdArry = new Array();
            
            for(i=0; i< 30; i++){
            	scheduleIdArry.push(C_COM.makeUniqueId());
            }

            requestParm["scheduleIdArry"]  = scheduleIdArry;
            /////////////////////////////////////////////////////////////////////
            
            var userArry = new Array();
            
            for(i=0; i< <@popupId>.userIndex; i++){
                var userId = $('#userId'+i).val();

                if(typeof userId != "undefined" && userId != null && userId != ""){
                    var item = new Object();
                    item.user_id  = userId;
                    userArry.push(item);
                }
            }
            requestParm["users"]  = JSON.stringify(userArry);
                    
            // 데이타 저장
            var parm = {
                 serviceId              : "ScheduleService.saveSchedule"
                ,requestParm            : requestParm
            }
            C_COM.requestService(parm, function(resultData) {
            	
                console.log("resultData.data.state =>"+resultData.data.state);
            	if("S" == resultData.data.state){

            		var obj = new Object();
                    obj.title = title;
                    obj.start = date+"T"+startTimeH+":"+startTimeM+":"+"00";
                    obj.end   = date+"T"+endTimeH+":"+endTimeM+":"+"00";
                    obj.textColor = "#fff";
                    
                    if( workType == 'SEMINAR'){//세미나
                        obj.color = "#d770c0";  
                    }else if( workType == 'SEND_EMAIL'){//이메일 전송
                        obj.color = "#72bfd2"; 
                    } else if( workType == 'OTHER_WORK'){//그 외 업무
                        obj.color = "#8dcc76"; 
                    } else if( workType == 'TEL_CONSUL'){//전화상담
                        obj.color = "#e5b266"; 
                    } else if( workType == 'MEETING'){//미팅
                        obj.color = "#EE7C7C"; 
                    } else if( workType == 'SCHEDULE'){//회사 내부 일정
                        obj.color = "#7E7CEE"; 
                    } else{} 
                    C_POP.close(obj);
                }else{
                    dalert("일정이 추가에 실패하였습니다.");
                }
                
            });
            
         }
    }//var <@popupId>
    
    // Popup Load가 완료된후 실행 된다.
    C_POP.onLoadPopup("<@popupId>", function(data) {

    	 
    	
    	var scheduleId = data["scheduleId"];
    	
    	console.log("=== scheduleId ===>"+scheduleId);
    	
    	if(typeof scheduleId != "undefined" && scheduleId != null && scheduleId != ""){
    		
    		console.log("=== 1111 ===>");
    		<@popupId>.scheduleId = scheduleId;
            <@popupId>.searchSchedule(<@popupId>.scheduleId);
            <@popupId>.mode = 'UPDATE';
    	}else{

            console.log("=== 2221 ===>");
    		<@popupId>.scheduleId = C_COM.makeUniqueId();// PK 생성
    		console.log("=== 2222 ===>");
    		<@popupId>.mode = 'INSERT';
    		console.log("=== 2223 ===>");
    		
    	}
    	console.log("=== 1 ===>");
    	
        //************** 업무유형 **************
        var workTypeList = C_COM.getCodeList("SCHEDULE_WORK_TYPE");
        
        var workTypeBoxList = { 
             data           : workTypeList
            ,targetId       : "selectBoxWorkType" 
        }
        C_UICOM.makeSelectBox(workTypeBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var workTypeCodeAttrList = C_COM.getCodeAttr("SCHEDULE_WORK_TYPE", "OTHER_WORK");
        
        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxWorkType", "OTHER_WORK");
        
        
        C_UICOM.addChangeListner("selectBoxWorkType", function(dataObj) {
            <@popupId>.workType = dataObj;
        });
        //============== 업무유형 ==============
      
        //************** 반복유형 **************
        var loopTypeList = C_COM.getCodeList("SCHEDULE_LOOP_TYPE");
        
        var loopTypeBoxList = { 
             data           : loopTypeList
            ,targetId       : "selectBoxLoopType"  
        }
        C_UICOM.makeSelectBox(loopTypeBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var loopTypeCodeAttrList = C_COM.getCodeAttr("SCHEDULE_LOOP_TYPE", "NOT_REPEAT");
        
        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxLoopType", "NOT_REPEAT");
      
        C_UICOM.addChangeListner("selectBoxLoopType", function(dataObj) {
        	<@popupId>.loopType = dataObj;
        });
        //============== 반복유형 ==============
        	
        //************** 공개여부 **************
        var secretYnList = C_COM.getCodeList("SCHEDULE_SECRET_YN");
        
        var secretYnBoxList = { 
             data           : secretYnList
            ,targetId       : "scheduleSecretYn" 
        }
        C_UICOM.makeSelectBox(secretYnBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var secretYnCodeAttrList = C_COM.getCodeAttr("SCHEDULE_SECRET_YN", "N");

        //초기값 세팅
        C_UICOM.setSingleBox("scheduleSecretYn", "N");
        
        C_UICOM.addChangeListner("scheduleSecretYn", function(dataObj) {
            //dalert(dataObj);
            <@popupId>.secretYn = dataObj;
            
        });
        //============== 공개여부 ==============
        	
        //************** 시작시간 **************
        var startTimeList = C_COM.getCodeList("TIME_HOUR_24");
        
        var startTimeBoxList = { 
             data           : startTimeList
            ,targetId       : "selectBoxStartTime" 
        }

        C_UICOM.makeSelectBox(startTimeBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var startTimeCodeAttrList = C_COM.getCodeAttr("TIME_HOUR_24", "00");

        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxStartTime", "00");
        
        C_UICOM.addChangeListner("selectBoxStartTime", function(dataObj) {
        	<@popupId>.startTimeH = dataObj;
        });

        //============== 시작시간 ==============
        
        //************** 시작분 **************
        var startMinuteList = C_COM.getCodeList("TIME_MINUTE_30");
        
        var startMinutBoxList = { 
             data           : startMinuteList
            ,targetId       : "selectBoxStartMinute" 
        }

        C_UICOM.makeSelectBox(startMinutBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var startMinutCodeAttrList = C_COM.getCodeAttr("TIME_MINUTE_30", "00");

        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxStartMinute", "00");
        
        C_UICOM.addChangeListner("selectBoxStartMinute", function(dataObj) {
        	<@popupId>.startTimeM = dataObj;
        });

        //============== 시작시간 ==============
        	
        //************** 종료시간 **************
        var endTimeList = C_COM.getCodeList("TIME_HOUR_24");
        
        var endTimeBoxList = { 
             data           : startTimeList
            ,targetId       : "selectBoxEndTime" 
        }

        C_UICOM.makeSelectBox(endTimeBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var endTimeCodeAttrList = C_COM.getCodeAttr("TIME_HOUR_24", "00");

        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxEndTime", "00");
        
        C_UICOM.addChangeListner("selectBoxEndTime", function(dataObj) {
            <@popupId>.endTimeH = dataObj;
        });

        //============== 종료시간 ==============
        	
        //************** 종료분 **************
        var endMinuteList = C_COM.getCodeList("TIME_MINUTE_30");
        
        var endMinutBoxList = { 
             data           : endMinuteList
            ,targetId       : "selectBoxEndMinute" 
        }

        C_UICOM.makeSelectBox(endMinutBoxList, "single");
        
        // 코드 Attr 읽어오기     
        var startMinutCodeAttrList = C_COM.getCodeAttr("TIME_MINUTE_30", "00");

        //초기값 세팅
        C_UICOM.setSingleBox("selectBoxEndMinute", "00");
        
        C_UICOM.addChangeListner("selectBoxEndMinute", function(dataObj) {
            <@popupId>.endTimeM = dataObj;
        });

        //============== 종료분 ==============
        	
        console.log("=== 2 ===>");
        	
        // 오늘날짜 세팅
        let date = new Date();
        
        let today = date.getFullYear() +
                          '-' + ( (date.getMonth()+1) <= 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1) )+
                          '-' + ( (date.getDate()) <= 9 ? "0" + (date.getDate()) : (date.getDate()) );
        
        $('#<@popupId>_date').val(today);

        //버튼 보임 처리
        if ( <@popupId>.mode == 'UPDATE') {
            $('#<@popupId>_btnDelete').show();
            $('#<@popupId>_btnUpdate').show();
            $('#<@popupId>_btnSave').hide();
            
            
        } else if ( <@popupId>.mode == 'INSERT') {
        	$('#<@popupId>_btnDelete').hide();
            $('#<@popupId>_btnUpdate').hide();
            $('#<@popupId>_btnSave').show();
            
        } else{}

    });
    
    
</script>
    <!-- 캘린더 일정추가 팝업 -->
    <div class="modal_wrap" id="modal-ex">
        <div class="modal" style="width:700px;height:750px;">
            <div class="modal_header">
                <strong class="tit">캘린더 일정추가</strong>
                <button type="button" class="btn_close" onclick="<@popupId>.close()"><span class="sp">팝업 닫기</span></button>
                
            </div>
            <div class="modal_body" style="overflow:visible;">
                <dl class="info_wrap">
                    <dt>제목</dt>
                    <dd><input id="<@popupId>_title" type="text" style="width:100%"></dd>
                    <dt>회사명</dt>
                    <dd><button type="button" class="btn select">고객 불러오기</button></dd>
                    <dt>업무 유형</dt>
                    <dd>
                        <div id="selectBoxWorkType" style="width:132px"></div>
                    </dd>
                    <dt>일정</dt>
                    <dd>
                        <div class="clearFix">
                            <div class="calendar_wrap fl">
                                <input type="text" class="datepicker" id="<@popupId>_date" style="width:185px">
                            </div>
                            <div class="select_box fl" style="width:calc(100% - 196px)">
                                <div id="selectBoxLoopType" style="width:100%"></div>
                            </div>
                        </div>
                        <div class="clearFix mt10">
                            <div class="fl">
                                <div id="selectBoxStartTime" style="width:80px"></div><div id="selectBoxStartMinute" style="width:80px"></div>
                            </div>
                            <div class="fl">
                                -
                            </div>
                            <div class="fl">
                                <div id="selectBoxEndTime"   style="width:80px"></div><div id="selectBoxEndMinute"  style="width:80px"></div>
                            </div>
                            <div class="fl">
                                <input type="checkbox" name="" id="day" class="pl10 lh33"><label for="day" class="ml5 lh33">종일</label>
                            </div>
                        </div>
                    </dd>
                    <dt>위치</dt>
                    <dd><input type="text" id="<@popupId>_position" placeholder="위치 추가" style="width:100%"></dd>
                    <dt>참석자</dt>
                    <dd>
                        <div class="search_inputWrap w100">
                            <input type="search" name="" placeholder="참석자 추가">
                            <button class="search_btn">
                                  <a href="javascript:void(0);" onclick="<@popupId>.memberSearchPopup();"><i class="icon_search"></i></a>
                            </button>
                        </div>
                    </dd>
                    <dt>참석자<br>리스트</dt>
                    <dd class="mb0" style="height:120px;overflow-y:auto;">
                        <div class="approver_list_wrap">
                            <ul class="<@popupId>approver_list">
	                            <li>
	                                <span class="txt">이응규 / 경영 지원 그룹 / 대리 / kbntt73@gmail.com</span>
	                            </li>
                            </ul>
                        </div>
                    </dd>
                    
                    <dt>공개 여부</dt>
                    <dd>
                        <div class="select_box">
                            <div id="scheduleSecretYn" style="width:132px"></div>
                        </div>
                    </dd>
                    <dt>설명 추가</dt>
                    <dd>
                        <input type="text" id="<@popupId>_description" style="width:100%">
                    </dd>
                </dl>
            </div>
            <div class="modal_footer">
                <button type="button" id="<@popupId>_btnDelete" class="btn select" onclick="<@popupId>.delete()" >삭제</button>
                <button type="button" id="<@popupId>_btnUpdate" class="btn select" onclick="<@popupId>.update()" >수정</button>
                <button type="button" id="<@popupId>_btnSave"   class="btn select" onclick="<@popupId>.save()" >저장</button>
                <button type="button" id="<@popupId>_btnClose"  class="btn close"  onclick="<@popupId>.close()" >취소</button>
            </div>
        </div>
    </div>


