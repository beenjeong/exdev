<meta charset="utf-8">
<script type="text/javascript">
	var <@popupId> = {
         userIndex : 0      
        ,userArr : []
        ,fileNo : 0
        ,filesArr : []
        ,requestParm : {}
		,memberSearchPopup : function() {

            console.log("======= memberSearchPopup 2 =======");
	        C_POP.open('popup_userSearchPopup', {}, function(retData) {
	            console.log("======= memberSearchPopup 3 =======");
	            console.log(retData);
	            <@popupId>.addMember(retData);
	        });
	     }
        ,addMember : function(retData) {
            
            for (let obj of retData) {
                console.log("obj.index =>"+obj.index);
                console.log("obj.user_id =>"+obj.user_id);
                console.log("obj.user_nm =>"+obj.user_nm);
                console.log("obj.user_desc =>"+obj.user_desc);
                console.log("obj.e_mail =>"+obj.e_mail);
                

                <@popupId>.userArr.push(obj.user_id);
                
                let user = obj.user_nm+"/"+obj.user_desc+"/"+obj.user_id+"/"+obj.e_mail;
                
                let htmlData = '';

                htmlData += '<li id="approvalUser'+ <@popupId>.userIndex +'" >';
                htmlData += '    <button class="stateBtn toggle active">결재</button>';
                htmlData += '    <button class="stateBtn toggle">합의</button>';
                htmlData += '    <button class="stateBtn toggle">통보</button>';
                htmlData += '    <span class="txt">' + user + '</span>';
                htmlData += '    <button class="pay_close" onclick="<@popupId>.deleteUser(' + <@popupId>.userIndex + ');">삭제</button>';
                htmlData += '</li>';
                
                $('#<@popupId> .approver_list').append(htmlData);
                <@popupId>.userIndex++;
            }
         }
        /* 결재상신 */
        ,save : function () {
            
            var groupId = "approval";
            
            if (groupId.length < 1) {
                alert("파일그룹 ID를 입력해 주세요.");
                $("#groupId").focus();
                return false;
            }
            var title = $("#<@popupId> #title").val();
            if (title.length < 1) {
                alert("제목을 입력해 주세요.");
                $("#<@popupId> #title").focus();
                return false;
            }
            var content = $("#<@popupId> #content").val();
            if (content.length < 1) {
                alert("상신 내용을 입력해 주세요.");
                $("#<@popupId> #content").focus();
                return false;
            }
            
            // 폼데이터 담기
            var form = document.querySelector("#<@popupId> form");
            
            var formData = new FormData(form);
            formData.append("appr_uuid", C_COM.makeUniqueId());
            
            for (var i = 0; i < <@popupId>.userArr.length; i++) {
                // 삭제되지 않은 결재자만 폼데이터에 담기
                if (!<@popupId>.userArr[i].is_delete) {
                    formData.append("user_ids", <@popupId>.userArr[i]);
                    formData.append("appr_user_uuid", C_COM.makeUniqueId());
                }
            }                
             
            console.log(" <@popupId>.filesArr.length ==>"+<@popupId>.filesArr.length);

            if( <@popupId>.filesArr.length >= 0 ){

                for (var i = 0; i < <@popupId>.filesArr.length; i++) {
                    // 삭제되지 않은 파일만 폼데이터에 담기
                    if (!<@popupId>.filesArr[i].is_delete) {
                        formData.append("attach_file", <@popupId>.filesArr[i]);
                        formData.append("file_uuids", C_COM.makeUniqueId());
                    }
                }	
            }else{

                formData.append("attach_file", "");
                formData.append("file_uuids", "");
            }
            

            $.ajax({
                url: '/approvalSave.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    const msg = response.msg;
                    alert(msg);
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
    
         }
        ,deleteUser : function(num) {/* 결재자 삭제 */
            $("#<@popupId> #approvalUser" + num).remove();
            <@popupId>.userArr[num].is_delete = true;
         }
		,close : function() {
			console.log("======= 자식창 C_POP.close =======");

	        C_POP.close();
		 }
	}
	// Popup Load가 완료된후 실행 된다.
	C_POP.onLoadPopup("<@popupId>", function(data) {
		
	});
	
	
</script>

    <!-- 결재 상신 팝업 -->
    <div class="modal_wrap" id="modal-ex01">
        <form method="POST" id="theForm" onsubmit="return false;" enctype="multipart/form-data">
        <input type="hidden" name="groupId" id="groupId" value="approval">
        <div class="modal" style="width:700px;height:600px;">
            <div class="modal_header">
                <strong class="tit">결재 상신</strong>
                <button type="button" class="btn_close" onclick="<@popupId>.close()"><span class="sp">팝업 닫기</span></button>
            </div>
            <div class="modal_body">
                <dl class="info_wrap pay">
                    <dt>제목</dt>
                    <dd><input type="text"  id='title' name='title' value='' style="width:100%"></dd>
                    <dt>결재자 검색</dt>
                    <dd>
                        <div class="search_inputWrap" style="width:100%">
                            <input type="search" name="">
                              <button class="search_btn">
                                  <a href="javascript:void(0);" onclick="<@popupId>.memberSearchPopup();"><i class="icon_search"></i></a>
                              </button>
                        </div>
                    </dd>
                    <dt>결재자 리스트</dt>
                    <dd class="mb0" style="height:120px;overflow-y:auto;">
                        <div class="approver_list_wrap">
                            <ul class="approver_list">
                                <li>
                                    <span class="stateBtn drafter">기 안 자</span>
                                    <span class="txt">김기안 / 경영 지원 그룹 / 대리 / abcx@explan.co.kr</span>
                                </li>
                            </ul>
                        </div>
                    </dd>
                    <dt>상신 내용</dt>
                    <dd style="height:70px;">
                        <textarea name="content" id="content" row=3 style="width:100%;height:200px;"></textarea>
                    </dd>                         
                </dl>
            </div>
             
            <div class="modal_footer">
                <button type="button" class="btn select" onclick="<@popupId>.save()">결재 상신</button>
                <button type="button" class="btn select">보류함</button>
                <button type="button" class="btn close"  onclick="<@popupId>.close()"      >취소</button>
            </div>
        </div>
     </form>       
    </div>




