<meta charset="utf-8">
<script type="text/javascript">
    var <@popupId> = {
         userIndex : 0      
        ,userArr : []
        ,fileNo : 0
        ,filesArr : []
        ,requestParm : {}
        ,apprId: ''
        ,editorData: ''
        ,memberSearchPopup : function() {

            C_POP.open('popup_userSearchPopup', {}, function(retData) {
                <@popupId>.addMember(retData);
            });
         }

        ,callCompFn : function() {
            <@popupId>.textEditorComp.testFn("aaa");
         }

        ,callCompSetMode : function() {
        	
        	let parm = {mode:"R"}
            <@popupId>.textEditorComp.setMode(parm);
         }
        
        ,addMember : function(retData) {
            
            for (let obj of retData) {
            	
                console.log("obj.spCstmId =>"+obj.spCstmId);
                console.log("obj.user_id =>"+obj.user_id);
                console.log("obj.user_nm =>"+obj.user_nm);
                console.log("obj.user_desc =>"+obj.user_desc);
                console.log("obj.e_mail =>"+obj.e_mail);
                
                <@popupId>.userArr.push(obj.user_id);
                
                let user = obj.user_nm+"/"+obj.user_desc+"/"+obj.user_id+"/"+obj.e_mail;
                
                let btnId1 = <@popupId>.userIndex +'0';
                let btnId2 = <@popupId>.userIndex +'1';
                let btnId3 = <@popupId>.userIndex +'2';
                
                let htmlData = '';
                htmlData += '<li id="approvalUser'+ <@popupId>.userIndex +'" >';
                htmlData += '<input type="hidden" id="userId'+ <@popupId>.userIndex +'"   name="userId"   value="'+ obj.user_id +'">';
                htmlData += '<input type="hidden" id="apprType'+ <@popupId>.userIndex +'" name="apprType" value="APPR">';
                htmlData += '    <button id="button'+ btnId1 +'" onclick="<@popupId>.setSelectUser(\''+btnId1+'\')" class="stateBtn toggle active">결재</button>';
                htmlData += '    <button id="button'+ btnId2 +'" onclick="<@popupId>.setSelectUser(\''+btnId2+'\')" class="stateBtn toggle">합의</button>';
                htmlData += '    <button id="button'+ btnId3 +'" onclick="<@popupId>.setSelectUser(\''+btnId3+'\')" class="stateBtn toggle">통보</button>';
                htmlData += '    <span class="txt">' + user + '</span>';
                htmlData += '    <button class="pay_close" onclick="<@popupId>.deleteUser(' + <@popupId>.userIndex + ');">삭제</button>';
                htmlData += '</li>';
                
                $('#<@popupId> .approver_list').append(htmlData);
                <@popupId>.userIndex++;
            }
         }

        ,setSelectUser : function(buttonId) {
            
            let rowNum = buttonId.substring(buttonId.length-2, buttonId.length-1);
            let colNum = buttonId.substring(buttonId.length-1, buttonId.length);
            
            for (var j = 0; j < 3; j++) {
                var buttonId2 = "button"+rowNum+j; 
                $('#'+buttonId2).removeClass('stateBtn toggle active');
            }
            
            for (var i = 0; i < 3; i++) {
            	
                for (var j = 0; j < 3; j++) {
                    if( i == rowNum && j == colNum ){
                        $('#button'+i+j).addClass('stateBtn toggle active');
                        if( colNum == 0 ){ $('#apprType'+i).val('APPR'); }
                        else if( colNum == 1 ){ $('#apprType'+i).val('AGREE');  }
                        else if( colNum == 2 ){ $('#apprType'+i).val('NOTICE');  }
                        else{}
                        
                        console.log("== colNum["+colNum+"]  ==");
                    }else{
                        $('#button'+i+j).addClass('stateBtn toggle');
                    }
                }
            }
         }
        
        
        /* 결재상신 */
        ,save : function (state) {
            
            var title = $("#<@popupId> #title").val();
            console.log("== title ==>"+title);
            if (title.length < 1) {
                alert("제목을 입력해 주세요.");
                $("#<@popupId> #title").focus();
                return false;
            }
            
            var content = <@popupId>.textEditorComp.getContent();
            
            if (content.length < 1) {
                alert("상신 내용을 입력해 주세요.");
                $("#<@popupId> #content").focus();
                return false;
            }
            
            if (<@popupId>.userArr.length < 1) {
                alert("결재자를 입력해 주세요.");
                return false;
            }
            // 폼데이터 담기
            var form = document.querySelector("#<@popupId> form");
            
            var formData = new FormData(form);
            formData.append('content', content);
            formData.append("apprId", <@popupId>.apprId);
            formData.append("state", state);
            
            var userArry = new Array();
            
            for(i=0; i< <@popupId>.userIndex; i++){
                var userId = $('#userId'+i).val();
                var apprType = $('#apprType'+i).val();

                if(typeof userId != "undefined" && userId != null && userId != ""){
                	var item = new Object();
                	item.user_id  = userId;
                	item.apprType = apprType;
                    userArry.push(item);
                }
            }
            
            formData.append('apprUsers', JSON.stringify(userArry));
            
            $.ajax({
                url: '/approvalSave.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    const msg = response.msg;
                    alert(msg);
                    <@popupId>.close();
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
    
         }
        ,deleteUser : function(num) {/* 결재자 삭제 */
            $("#<@popupId> #approvalUser" + num).remove();
            <@popupId>.userArr[num].is_delete = true;
         }
        ,close : function() {
            console.log("======= 자식창 C_POP.close =======");

            C_POP.close();
         }
        
        /*첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    */
        
        /* 첨부파일 추가 */
        ,addFile1: function(){

            console.log("======= addFile1 =======");
        }
        ,addFile : function(obj){
            console.log("======= addFile =======");
            
            var maxFileCnt = 5;   // 첨부파일 최대 개수
            var attFileCnt = document.querySelectorAll('.filebox').length;    // 기존 추가된 첨부파일 개수
            var remainFileCnt = maxFileCnt - attFileCnt;    // 추가로 첨부가능한 개수
            
            console.log("======= obj =======");
            var curFileCnt = obj.files.length;  // 현재 선택된 첨부파일 개수
            console.log("======= curFileCnt ======="+curFileCnt);
            // 첨부파일 개수 확인
            if (curFileCnt > remainFileCnt) {
                alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
            }

            for (var i = 0; i < Math.min(curFileCnt, remainFileCnt); i++) {

                const file = obj.files[i];
                console.log("======= apprId ======="+<@popupId>.apprId); 
                
                // 첨부파일 검증
                if (<@popupId>.validation(file)) {
                    <@popupId>.uploadMultiFile(file)                    
                } else {
                    continue;
                }
            }
            // 초기화
            //document.querySelector("input[type=file]").value = "";
            $("#<@popupId> input[type=file]").val("");
         }
        /* 첨부파일 추가 */
        ,uploadMultiFile : function (file) {
            
            var groupUuId = <@popupId>.apprId;
            
            if (groupUuId.length < 1) {
                alert("파일그룹 ID를 입력해 주세요.");
                return false;
            }

            // 폼데이터 담기
            var form = document.querySelector("#<@popupId> form");
            var formData = new FormData(form);

            formData.append("groupId", "TBL_EXP_APPROVAL");
            formData.append("groupUuId", groupUuId);
            formData.append("attach_file", file);
            formData.append("uploadPath", "uploadFiles");
            
            
            formData.append("uuids", C_COM.makeUniqueId());

            $.ajax({
                url: '/multiFileUpload.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    
                    var msg = response.msg;
                    var list = response.list;
                    var temp ="";
                    
                    console.log("== msg ==>"+msg);
                    
                    for(var i=0; i< list.length; i++) {
                        <@popupId>.addhtmlData(file,list[i]);
                    }
                    
                    return true;
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return false;
                }
            })
            console.log("uploadMultiFile");
            return false;
    
         }
        ,addhtmlData : function (file, fileUuid) {
            
            console.log("== fileUuid ==>"+fileUuid);
            
            // 파일 배열에 담기
            var reader = new FileReader();
            reader.onload = function () {
                <@popupId>.filesArr.push(file);
            };
            reader.readAsDataURL(file)

            // 목록 추가
            let htmlData = '';
            htmlData += '<div id="file' + <@popupId>.fileNo + '" class="filebox">';
            htmlData += '   <p class="name">' + file.name + '</p>';
            htmlData += '   <button onclick="<@popupId>.deleteFile(' + <@popupId>.fileNo + ', \''+fileUuid+'\' );">삭제</button>';
            htmlData += '</div>';
            $('#<@popupId> .file-list').append(htmlData);
            <@popupId>.fileNo++;
    
         }

        /* 첨부파일 검증 */
        ,validation : function(obj){
            const fileTypes = ['application/pdf', 'image/gif', 'image/jpeg', 'image/png', 'image/bmp', 'image/tif', 'application/haansofthwp', 'application/x-hwp'];
            if (obj.name.length > 100) {
                alert("파일명이 100자 이상인 파일은 제외되었습니다.");
                return false;
            } else if (obj.size > (100 * 1024 * 1024)) {
                alert("최대 파일 용량인 100MB를 초과한 파일은 제외되었습니다.");
                return false;
            } else if (obj.name.lastIndexOf('.') == -1) {
                alert("확장자가 없는 파일은 제외되었습니다.");
                return false;
            } else if (!fileTypes.includes(obj.type)) {
                alert("첨부가 불가능한 파일은 제외되었습니다.");
                return false;
            } else {
                return true;
            }
         }
        /* 첨부파일 삭제 */
        ,deleteFile : function(num,fileUuid) {
            console.log("== deleteFile fileUuid ==>"+fileUuid);

            let formData = new FormData();
            formData.append("delete_file_list", fileUuid);
            
            $.ajax({
                url: '/fileDelete.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    const msg = response.msg;
                    alert(msg);

                    $("#<@popupId> #file" + num).remove();
                    <@popupId>.filesArr[num].is_delete = true;
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
            
         }
        /*첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    */
    }
    // Popup Load가 완료된후 실행 된다.
    C_POP.onLoadPopup("<@popupId>", function(data) {
        <@popupId>.apprId = C_COM.makeUniqueId();// 첨부파일
        C_COMP.import("textEditorComp", "component_compTextEditor1", {content:"text sample"}, function(data) {
            
            console.log(data.editorData);
            <@popupId>.editorData = data.editorData;
            
        });
    });
    
    
</script>

    <!-- 결재 상신 팝업 -->
    <div class="modal_wrap" id="modal-ex01">
        <form method="POST" id="theForm" onsubmit="return false;" enctype="multipart/form-data">
        <div class="modal" style="width:900px;height:1000px;">
            <div class="modal_header">
                <strong class="tit">결재 상신</strong>
                <button type="button" class="btn_close" onclick="<@popupId>.close()"><span class="sp">팝업 닫기</span></button>
            </div>
            <div class="modal_body">
                <dl class="info_wrap pay">
                    <dt>제목</dt>
                    <dd><input type="text"  id='title' name='title' value='' style="width:100%"></dd>
                    <dt>결재자 검색</dt>
                    <dd>
                        <div class="search_inputWrap" style="width:100%">
                            <input type="search" name="">
                              <button class="search_btn">
                                  <a href="javascript:void(0);" onclick="<@popupId>.memberSearchPopup();"><i class="icon_search"></i></a>
                              </button>
                        </div>
                    </dd>
                    <dt>결재자 리스트</dt>
                    <dd class="mb0" style="height:120px;overflow-y:auto;">
                        <div class="approver_list_wrap">
                            <ul class="approver_list">
                                <li>
                                    <span class="stateBtn drafter">기 안 자</span>
                                    <span class="txt">김기안 / 경영 지원 그룹 / 대리 / abcx@explan.co.kr</span>
                                </li>
                            </ul>
                        </div>
                    </dd>
                    <dt>상신 내용</dt>
                    <dd style="height:70px;">
                        <div id="textEditorComp" style="width:100%;height:100%">
                        </div>
                        
                    </dd> 
                    <!-- 
                    <dt>상신 내용</dt>
                    <dd style="height:70px;">
                        <input type="file" onchange="<@popupId>.addFile(this);" multiple />
                        <div class="file-list"></div>
                        <div id="result"/>
                    </dd>
                     --> 
                </dl>
            </div>
            <div class="modal_footer">
                <button type="button" class="btn select" onclick="<@popupId>.save('REQUEST')">결재 상신</button>
                <button type="button" class="btn select" onclick="<@popupId>.save('HOLD')">보류함</button>
                <button type="button" class="btn close"  onclick="<@popupId>.close()"      >취소</button>
                <!-- 
                <button type="button" class="btn close"  onclick="<@popupId>.callCompFn()"      >compt function 호출</button>
                <button type="button" class="btn close"  onclick="<@popupId>.callCompSetMode()"      >callCompSetMode</button>
                 --> 
            </div>
        </div>
     </form>
    </div>




