<meta charset="utf-8">
<script type="text/javascript">
    var <@popupId> = {
         userIndex : 0      
        ,userArr : []
        ,fileNo : 0
        ,filesArr : []
        ,requestParm : {}
        ,fileFKUuid: '' /* 첨부파일 */
        ,memberSearchPopup : function() {

            console.log("======= memberSearchPopup 2 =======");
            C_POP.open('popup_userSearchPopup', {}, function(retData) {
                console.log("======= memberSearchPopup 3 =======");
                console.log(retData);
                <@popupId>.addMember(retData);
            });
         }
        ,addMember : function(retData) {
            
            for (let obj of retData) {
                console.log("obj.index =>"+obj.index);
                console.log("obj.user_id =>"+obj.user_id);
                console.log("obj.user_nm =>"+obj.user_nm);
                console.log("obj.user_desc =>"+obj.user_desc);
                console.log("obj.e_mail =>"+obj.e_mail);
                

                <@popupId>.userArr.push(obj.user_id);
                
                let user = obj.user_nm+"/"+obj.user_desc+"/"+obj.user_id+"/"+obj.e_mail;
                
                
                
                let btnId1 = <@popupId>.userIndex +'0';
                let btnId2 = <@popupId>.userIndex +'1';
                let btnId3 = <@popupId>.userIndex +'2';
                
                let htmlData = '';
                htmlData += '<li id="approvalUser'+ <@popupId>.userIndex +'" >';
                htmlData += '<input type="hidden" id="userId'+ <@popupId>.userIndex +'" name="userId'+ <@popupId>.userIndex +'" value="userId'+ obj.user_id +'">';
                htmlData += '    <button id="button'+ btnId1 +'" onclick="<@popupId>.setSelectUser(\''+btnId1+'\')" class="stateBtn toggle active">결재</button>';
                htmlData += '    <button id="button'+ btnId2 +'" onclick="<@popupId>.setSelectUser(\''+btnId2+'\')" class="stateBtn toggle">합의</button>';
                htmlData += '    <button id="button'+ btnId3 +'" onclick="<@popupId>.setSelectUser(\''+btnId3+'\')" class="stateBtn toggle">통보</button>';
                htmlData += '    <span class="txt">' + user + '</span>';
                htmlData += '    <button class="pay_close" onclick="<@popupId>.deleteUser(' + <@popupId>.userIndex + ');">삭제</button>';
                htmlData += '</li>';
                
                $('#<@popupId> .approver_list').append(htmlData);
                <@popupId>.userIndex++;
            }
         }

        ,setSelectUser : function(buttonId) {
            
            let rowNum = buttonId.substring(buttonId.length-2, buttonId.length-1);
            let colNum = buttonId.substring(buttonId.length-1, buttonId.length);
            
            for (var j = 0; j < 3; j++) {
                var buttonId2 = "button"+rowNum+j; 
                $('#'+buttonId2).removeClass('stateBtn toggle active');
            }
            
            for (var i = 0; i < 3; i++) {
                for (var j = 0; j < 3; j++) {
                    if( i == rowNum && j == colNum ){
                        $('#button'+i+j).addClass('stateBtn toggle active');
                    }else{
                        $('#button'+i+j).addClass('stateBtn toggle');
                    }
                }
            }
         }
        
        
        /* 결재상신 */
        ,save : function () {
            

            for (var i = 0; i < <@popupId>.userIndex ; i++) {
                console.log("11");
            }
            return;

            
            var title = $("#<@popupId> #title").val();
            if (title.length < 1) {
                alert("제목을 입력해 주세요.");
                $("#<@popupId> #title").focus();
                return false;
            }
            var content = $("#<@popupId> #content").val();
            if (content.length < 1) {
                alert("상신 내용을 입력해 주세요.");
                $("#<@popupId> #content").focus();
                return false;
            }
            if (<@popupId>.userArr.length < 1) {
                alert("결재자를 입력해 주세요.");
                return false;
            }
            // 폼데이터 담기
            var form = document.querySelector("#<@popupId> form");
            
            var formData = new FormData(form);
            formData.append("appr_uuid", <@popupId>.fileFKUuid);
            
            for (var i = 0; i < <@popupId>.userArr.length; i++) {
                // 삭제되지 않은 결재자만 폼데이터에 담기
                if (!<@popupId>.userArr[i].is_delete) {
                    formData.append("user_ids", <@popupId>.userArr[i]);
                    formData.append("appr_user_uuid", C_COM.makeUniqueId());
                }
            }


            $.ajax({
                url: '/approvalSave.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    const msg = response.msg;
                    alert(msg);
                    <@popupId>.close();
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
    
         }
        ,deleteUser : function(num) {/* 결재자 삭제 */
            $("#<@popupId> #approvalUser" + num).remove();
            <@popupId>.userArr[num].is_delete = true;
         }
        ,close : function() {
            console.log("======= 자식창 C_POP.close =======");

            C_POP.close();
         }
        
        /*첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    */
        /* 첨부파일 추가 */
        ,addFile1 : function(obj){
            var maxFileCnt = 5;   // 첨부파일 최대 개수
            var attFileCnt = document.querySelectorAll('.filebox').length;    // 기존 추가된 첨부파일 개수
            var remainFileCnt = maxFileCnt - attFileCnt;    // 추가로 첨부가능한 개수
            var curFileCnt = obj.files.length;  // 현재 선택된 첨부파일 개수

            // 첨부파일 개수 확인
            if (curFileCnt > remainFileCnt) {
                alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
            }

            for (var i = 0; i < Math.min(curFileCnt, remainFileCnt); i++) {

                const file = obj.files[i];
                console.log("======= apprUuid ======="+<@popupId>.apprUuid); 
                
                // 첨부파일 검증
                if (<@popupId>.validation(file)) {
                    
                    // 파일 배열에 담기
                    var reader = new FileReader();
                    reader.onload = function () {
                        <@popupId>.filesArr.push(file);
                    };
                    reader.readAsDataURL(file)

                    // 목록 추가
                    let htmlData = '';
                    htmlData += '<div id="file' + <@popupId>.fileNo + '" class="filebox">';
                    htmlData += '   <p class="name">' + file.name + '</p>';
                    htmlData += '   <button onclick="<@popupId>.deleteFile(' + <@popupId>.fileNo + ');">삭제</button>';
                    htmlData += '</div>';
                    $('#<@popupId> .file-list').append(htmlData);
                    <@popupId>.fileNo++;
                } else {
                    continue;
                }
            }
            // 초기화
            //document.querySelector("input[type=file]").value = "";
            $("#<@popupId> input[type=file]").val("");
         }
        
        /* 첨부파일 추가 */
        ,addFile : function(obj){
            var maxFileCnt = 5;   // 첨부파일 최대 개수
            var attFileCnt = document.querySelectorAll('.filebox').length;    // 기존 추가된 첨부파일 개수
            var remainFileCnt = maxFileCnt - attFileCnt;    // 추가로 첨부가능한 개수
            var curFileCnt = obj.files.length;  // 현재 선택된 첨부파일 개수

            // 첨부파일 개수 확인
            if (curFileCnt > remainFileCnt) {
                alert("첨부파일은 최대 " + maxFileCnt + "개 까지 첨부 가능합니다.");
            }

            for (var i = 0; i < Math.min(curFileCnt, remainFileCnt); i++) {

                const file = obj.files[i];
                console.log("======= apprUuid ======="+<@popupId>.apprUuid); 
                
                // 첨부파일 검증
                if (<@popupId>.validation(file)) {
                    <@popupId>.uploadMultiFile(file)                    
                } else {
                    continue;
                }
            }
            // 초기화
            //document.querySelector("input[type=file]").value = "";
            $("#<@popupId> input[type=file]").val("");
         }
        /* 첨부파일 추가 */
        ,uploadMultiFile : function (file) {
            
            var groupId = <@popupId>.fileFKUuid;
            
            if (groupId.length < 1) {
                alert("파일그룹 ID를 입력해 주세요.");
                return false;
            }

            // 폼데이터 담기
            var form = document.querySelector("#<@popupId> form");
            var formData = new FormData(form);

            formData.append("groupId", groupId);
            formData.append("attach_file", file);
            formData.append("uuids", C_COM.makeUniqueId());

            $.ajax({
                url: '/multiFileUpload.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    
                    var msg = response.msg;
                    var list = response.list;
                    var temp ="";
                    
                    console.log("== msg ==>"+msg);
                    
                    for(var i=0; i< list.length; i++) {
                        <@popupId>.addhtmlData(file,list[i]);
                    }
                    
                    return true;
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return false;
                }
            })
            console.log("uploadMultiFile");
            return false;
    
         }
        ,addhtmlData : function (file, fileUuid) {
            
            console.log("== fileUuid ==>"+fileUuid);
            
            // 파일 배열에 담기
            var reader = new FileReader();
            reader.onload = function () {
                <@popupId>.filesArr.push(file);
            };
            reader.readAsDataURL(file)

            // 목록 추가
            let htmlData = '';
            htmlData += '<div id="file' + <@popupId>.fileNo + '" class="filebox">';
            htmlData += '   <p class="name">' + file.name + '</p>';
            htmlData += '   <button onclick="<@popupId>.deleteFile(' + <@popupId>.fileNo + ', \''+fileUuid+'\' );">삭제</button>';
            htmlData += '</div>';
            $('#<@popupId> .file-list').append(htmlData);
            <@popupId>.fileNo++;
    
         }

        /* 첨부파일 검증 */
        ,validation : function(obj){
            const fileTypes = ['application/pdf', 'image/gif', 'image/jpeg', 'image/png', 'image/bmp', 'image/tif', 'application/haansofthwp', 'application/x-hwp'];
            if (obj.name.length > 100) {
                alert("파일명이 100자 이상인 파일은 제외되었습니다.");
                return false;
            } else if (obj.size > (100 * 1024 * 1024)) {
                alert("최대 파일 용량인 100MB를 초과한 파일은 제외되었습니다.");
                return false;
            } else if (obj.name.lastIndexOf('.') == -1) {
                alert("확장자가 없는 파일은 제외되었습니다.");
                return false;
            } else if (!fileTypes.includes(obj.type)) {
                alert("첨부가 불가능한 파일은 제외되었습니다.");
                return false;
            } else {
                return true;
            }
         }
        /* 첨부파일 삭제 */
        ,deleteFile : function(num,fileUuid) {
            console.log("== deleteFile fileUuid ==>"+fileUuid);

            let formData = new FormData();
            formData.append("delete_file_list", fileUuid);
            
            $.ajax({
                url: '/fileDelete.do',
                method: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    const msg = response.msg;
                    alert(msg);

                    $("#<@popupId> #file" + num).remove();
                    <@popupId>.filesArr[num].is_delete = true;
                },
                error: function (xhr, desc, err) {
                    alert('에러가 발생 하였습니다.');
                    return;
                }
            })
            
         }
        /*첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    첨부 파일    */
    }
    // Popup Load가 완료된후 실행 된다.
    C_POP.onLoadPopup("<@popupId>", function(data) {
        <@popupId>.fileFKUuid = C_COM.makeUniqueId();// 첨부파일
    });
    
    
</script>

    <!-- 결재 상신 팝업 -->
    <div class="modal_wrap" id="modal-ex01">
        <form method="POST" id="theForm" onsubmit="return false;" enctype="multipart/form-data">
        <div class="modal" style="width:700px;height:800px;">
            <div class="modal_header">
                <strong class="tit">결재 상신</strong>
                <button type="button" class="btn_close" onclick="<@popupId>.close()"><span class="sp">팝업 닫기</span></button>
            </div>
            <div class="modal_body">
                <dl class="info_wrap pay">
                    <dt>제목</dt>
                    <dd><input type="text"  id='title' name='title' value='' style="width:100%"></dd>
                    <dt>결재자 검색</dt>
                    <dd>
                        <div class="search_inputWrap" style="width:100%">
                            <input type="search" name="">
                              <button class="search_btn">
                                  <a href="javascript:void(0);" onclick="<@popupId>.memberSearchPopup();"><i class="icon_search"></i></a>
                              </button>
                        </div>
                    </dd>
                    <dt>결재자 리스트</dt>
                    <dd class="mb0" style="height:120px;overflow-y:auto;">
                        <div class="approver_list_wrap">
                            <ul class="approver_list">
                                <li>
                                    <span class="stateBtn drafter">기 안 자</span>
                                    <span class="txt">김기안 / 경영 지원 그룹 / 대리 / abcx@explan.co.kr</span>
                                </li>
                            </ul>
                        </div>
                    </dd>
                    <dt>상신 내용</dt>
                    <dd style="height:70px;">
                        <textarea name="content" id="content" row=3 style="width:100%;height:100px;"></textarea>
                    </dd> 
                    <dt>상신 내용</dt>
                    <dd style="height:70px;">
                        <input type="file" onchange="<@popupId>.addFile(this);" multiple />
                        <div class="file-list"></div>
                        <div id="result"/>
                    </dd> 
                </dl>
            </div>
            <div class="modal_footer">
                <button type="button" class="btn select" onclick="<@popupId>.save()">결재 상신</button>
                <button type="button" class="btn select">보류함</button>
                <button type="button" class="btn close"  onclick="<@popupId>.close()"      >취소</button>
            </div>
        </div>
     </form>
           
    </div>
    




